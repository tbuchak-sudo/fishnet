<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gromada</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff9800">
    <link rel="apple-touch-icon" href="icon.png"> 

    <!-- –ö–ê–†–¢–ò -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-body: #f4f7f6; 
            --bg-card: #ffffff;
            --text-main: #333333; --text-sec: #777777;
            --border: #e0e0e0;
            
            /* –°—Ç–∏–ª—å "–ö–∞–±–∞–Ω—á–∏–∫–∞": –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π + –¢–µ–º–Ω–∏–π */
            --primary: #ff9800; /* –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–ª—ñ—Ä (–∫–Ω–æ–ø–∫–∏, –∞–∫—Ü–µ–Ω—Ç–∏) */
            --primary-dark: #f57c00;
            --header-bg: #2d3436; /* –¢–µ–º–Ω–∞ —à–∞–ø–∫–∞ */
            --price-tag: #27ae60; /* –ó–µ–ª–µ–Ω–∏–π –¥–ª—è –≥—Ä–æ—à–µ–π */
            
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body.dark-mode {
            --bg-body: #121212; --bg-card: #1e1e1e;
            --text-main: #e0e0e0; --text-sec: #aaaaaa;
            --border: #333333;
            --header-bg: #000000;
            --shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            max-width: 600px; margin: 0 auto; background: var(--bg-body); 
            color: var(--text-main); padding-bottom: 90px; transition: 0.3s;
        }
        
        /* HEADER */
        header { 
            background: var(--header-bg); color: #fff; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow);
        }
        .logo { font-weight: 900; font-size: 22px; cursor: pointer; color: var(--primary); letter-spacing: 1px; }
        .nav-icons { display: flex; gap: 15px; }
        .nav-btn { background: none; border: none; font-size: 22px; cursor: pointer; filter: grayscale(1); transition: 0.2s; }
        .nav-btn.active { filter: grayscale(0); transform: scale(1.1); }

        /* CATEGORIES SCROLL */
        .categories-scroll {
            display: flex; overflow-x: auto; gap: 10px; padding: 15px; 
            background: var(--bg-body); position: sticky; top: 60px; z-index: 90;
            scrollbar-width: none; /* Firefox */
        }
        .categories-scroll::-webkit-scrollbar { display: none; }
        
        .cat-chip {
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 20px; white-space: nowrap;
            font-size: 14px; font-weight: 500; cursor: pointer; color: var(--text-sec);
            transition: 0.2s;
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* TASK CARD (–ó–∞–≤–¥–∞–Ω–Ω—è) */
        .task-card { 
            background: var(--bg-card); margin: 15px; padding: 20px; 
            border-radius: var(--radius); box-shadow: var(--shadow); 
            border: 1px solid var(--border); position: relative;
        }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .task-title { font-size: 18px; font-weight: 700; color: var(--text-main); line-height: 1.3; }
        .task-price { 
            background: #e8f5e9; color: var(--price-tag); 
            padding: 5px 10px; border-radius: 8px; font-weight: 800; font-size: 16px; 
            white-space: nowrap; margin-left: 10px;
        }
        body.dark-mode .task-price { background: #1b5e20; color: #fff; }

        .task-meta { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-sec); margin-bottom: 15px; }
        .task-desc { font-size: 15px; line-height: 1.5; color: var(--text-main); margin-bottom: 15px; }
        .task-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #eee; }

        .task-footer { 
            border-top: 1px solid var(--border); padding-top: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .author-info { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; cursor: pointer;}
        .author-avatar { width: 32px; height: 32px; border-radius: 50%; }
        
        .btn-respond { 
            background: var(--primary); color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; 
            text-decoration: none; display: inline-block;
        }
        .btn-respond:hover { background: var(--primary-dark); }

        /* VIEWS */
        .view { display: none; }
        .view.active { display: block; }

        /* PROFILE */
        .profile-header { text-align: center; padding: 30px 20px; background: var(--bg-card); margin-bottom: 20px; }
        .profile-avatar-lg { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .profile-name { font-size: 22px; font-weight: 800; margin: 10px 0; }
        .profile-role { color: var(--primary); font-weight: 600; margin-bottom: 10px; }
        
        .info-list { background: var(--bg-card); padding: 0 20px; }
        .info-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .info-label { color: var(--text-sec); }
        .info-val { font-weight: 600; }

        /* FAB & MODAL */
        .fab { 
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; 
            background: var(--primary); color: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 32px; 
            cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); 
            transition: 0.3s;
        }
        .fab:hover { transform: scale(1.1); }
        .fab.hidden { display: none; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);}
        .modal-overlay.open { display: flex; }
        .modal-card { width: 90%; max-width: 500px; background: var(--bg-card); padding: 25px; border-radius: var(--radius); max-height: 90vh; overflow-y: auto; }

        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: var(--text-sec); }
        .app-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-body); color: var(--text-main); box-sizing: border-box; font-size: 16px; }
        
        #map-container { height: calc(100vh - 60px); width: 100%; }
        #map { height: 100%; width: 100%; }
        
        .location-btn { 
            background: #e3f2fd; color: #2196f3; padding: 10px; 
            border-radius: 8px; text-align: center; cursor: pointer; font-weight: 600; 
            border: 1px dashed #2196f3; margin-top: 5px;
        }
        .location-btn.active { background: #2196f3; color: white; border-style: solid; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="switchView('home')">Gromada üá∫üá¶</div>
        <div class="nav-icons">
            <button class="nav-btn" onclick="switchView('map')" title="–ö–∞—Ä—Ç–∞ –∑–∞–≤–¥–∞–Ω—å">üó∫Ô∏è</button>
            <button class="nav-btn" onclick="openProfile()" title="–ü—Ä–æ—Ñ—ñ–ª—å">üë§</button>
        </div>
    </header>

    <!-- === 1. HOME VIEW (–°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å) === -->
    <div id="view-home" class="view active">
        <!-- –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó -->
        <div class="categories-scroll">
            <div class="cat-chip active" onclick="filterCat('all', this)">–í—Å—ñ</div>
            <div class="cat-chip" onclick="filterCat('–°–∞–Ω—Ç–µ—Ö–Ω—ñ–∫–∞', this)">üõÅ –°–∞–Ω—Ç–µ—Ö–Ω—ñ–∫–∞</div>
            <div class="cat-chip" onclick="filterCat('–ï–ª–µ–∫—Ç—Ä–∏–∫–∞', this)">‚ö° –ï–ª–µ–∫—Ç—Ä–∏–∫–∞</div>
            <div class="cat-chip" onclick="filterCat('–î–æ—Å—Ç–∞–≤–∫–∞', this)">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</div>
            <div class="cat-chip" onclick="filterCat('–†–µ–º–æ–Ω—Ç', this)">üî® –†–µ–º–æ–Ω—Ç</div>
            <div class="cat-chip" onclick="filterCat('–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è', this)">üßπ –ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è</div>
            <div class="cat-chip" onclick="filterCat('–ì–æ—Ä–æ–¥', this)">ü•ï –ì–æ—Ä–æ–¥/–°–∞–¥</div>
            <div class="cat-chip" onclick="filterCat('–Ü–Ω—à–µ', this)">üìå –Ü–Ω—à–µ</div>
        </div>

        <div id="tasks-feed">
            <!-- –¢—É—Ç –±—É–¥—É—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è -->
        </div>
        
        <div id="fab" class="fab hidden" onclick="toggleModal('task-modal', true)">+</div>
    </div>

    <!-- === 2. MAP VIEW === -->
    <div id="view-map" class="view">
        <div id="map-container"><div id="map"></div></div>
    </div>

    <!-- === 3. PROFILE VIEW === -->
    <div id="view-profile" class="view">
        <div id="profile-content"></div> <!-- –¢—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –ø—Ä–æ—Ñ—ñ–ª—å -->
    </div>

    <!-- MODAL: –°–¢–í–û–†–ï–ù–ù–Ø –ó–ê–í–î–ê–ù–ù–Ø -->
    <div id="task-modal" class="modal-overlay" onclick="if(event.target===this) toggleModal('task-modal', false)">
        <div class="modal-card">
            <h2 style="margin-top:0">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
            
            <div class="input-group">
                <label class="input-label">–©–æ —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏? (–ó–∞–≥–æ–ª–æ–≤–æ–∫)</label>
                <input id="task-title" class="app-input" placeholder="–ù–∞–ø—Ä: –ü–æ–ª–∞–≥–æ–¥–∏—Ç–∏ –∫—Ä–∞–Ω">
            </div>

            <div class="input-group">
                <label class="input-label">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select id="task-cat" class="app-input">
                    <option>–°–∞–Ω—Ç–µ—Ö–Ω—ñ–∫–∞</option>
                    <option>–ï–ª–µ–∫—Ç—Ä–∏–∫–∞</option>
                    <option>–î–æ—Å—Ç–∞–≤–∫–∞</option>
                    <option>–†–µ–º–æ–Ω—Ç</option>
                    <option>–ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è</option>
                    <option>–ì–æ—Ä–æ–¥</option>
                    <option>–Ü–Ω—à–µ</option>
                </select>
            </div>

            <div class="input-group">
                <label class="input-label">–ë—é–¥–∂–µ—Ç (–≥—Ä–Ω)</label>
                <input id="task-price" type="number" class="app-input" placeholder="500">
            </div>

            <div class="input-group">
                <label class="input-label">–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å</label>
                <textarea id="task-desc" class="app-input" rows="3" placeholder="–û–ø–∏—à—ñ—Ç—å –¥–µ—Ç–∞–ª—ñ..."></textarea>
            </div>

            <div class="input-group">
                <div id="location-btn" class="location-btn" onclick="getLocation()">üìç –î–æ–¥–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é (GPS)</div>
            </div>

            <button onclick="createTask()" class="btn-respond" style="width:100%">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
        </div>
    </div>

    <!-- MODAL: –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ -->
    <div id="edit-modal" class="modal-overlay" onclick="if(event.target===this) toggleModal('edit-modal', false)">
        <div class="modal-card">
            <h2>–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</h2>
            <div class="input-group"><label class="input-label">–Ü–º'—è</label><input id="edit-name" class="app-input"></div>
            <div class="input-group"><label class="input-label">–¢–µ–ª–µ—Ñ–æ–Ω (–¥–ª—è –∑–≤'—è–∑–∫—É)</label><input id="edit-phone" class="app-input" placeholder="+380..."></div>
            <div class="input-group"><label class="input-label">–ú–æ—ó –Ω–∞–≤–∏—á–∫–∏</label><input id="edit-skills" class="app-input" placeholder="–ü–ª–∏—Ç–∫–∞, –ï–ª–µ–∫—Ç—Ä–∏–∫–∞..."></div>
            <button onclick="saveProfile()" class="btn-respond" style="width:100%">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <br><br>
            <button onclick="signOutAndReload()" style="width:100%; background:#e74c3c; border:none; color:white; padding:10px; border-radius:8px; cursor:pointer;">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø (–¢—ñ —Å–∞–º—ñ –∫–ª—é—á—ñ, —â–æ –π –±—É–ª–∏)
        const firebaseConfig = {
            apiKey: "AIzaSyCN7xN8AZXXCxwf9GmuILYi5AcKAUYJVB4",
            authDomain: "fishnet-cb1ad.firebaseapp.com",
            projectId: "fishnet-cb1ad",
            messagingSenderId: "672721719482",
            appId: "1:672721719482:web:9b0ce0e3e41893fcccb283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let userData = {};
        let allTasks = [];
        let currentFilter = 'all';
        let map = null;
        let taskLocation = null;

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('fab').classList.remove('hidden');
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
                const ref = doc(db, "users", user.uid);
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    userData = snap.data();
                } else {
                    userData = { name: user.displayName, phone: "", skills: "" };
                    await setDoc(ref, userData);
                }
            } else {
                signInWithPopup(auth, new GoogleAuthProvider()); // –ü—Ä–∏–º—É—Å–æ–≤–∏–π –≤—Ö—ñ–¥
            }
        });

        // --- NAVIGATION ---
        window.switchView = (viewName) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            if (viewName === 'map') initMap();
        };

        window.openProfile = () => {
            if(!currentUser) return;
            // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ—ñ–ª—é –≤ —Ä–µ–∂–∏–º—ñ –ø–µ—Ä–µ–≥–ª—è–¥—É
            document.getElementById('profile-content').innerHTML = `
                <div class="profile-header">
                    <img src="${currentUser.photoURL}" class="profile-avatar-lg">
                    <div class="profile-name">${userData.name}</div>
                    <div class="profile-role">üõ†Ô∏è –ú–∞–π—Å—Ç–µ—Ä / –ó–∞–º–æ–≤–Ω–∏–∫</div>
                    <button onclick="openEditModal()" class="btn-respond" style="background:#333; margin-top:10px;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                </div>
                <div class="info-list">
                    <div class="info-item"><div class="info-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω</div><div class="info-val">${userData.phone || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"}</div></div>
                    <div class="info-item"><div class="info-label">üî® –ù–∞–≤–∏—á–∫–∏</div><div class="info-val">${userData.skills || "–ù–µ–º–∞—î"}</div></div>
                </div>
            `;
            switchView('profile');
        };

        // --- TASKS LOGIC ---
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å (—Ç–µ–ø–µ—Ä 'tasks', –∞ –Ω–µ 'posts')
        // –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—É —Å–∞–º—É –∫–æ–ª–µ–∫—Ü—ñ—é 'posts', —â–æ–± –Ω–µ –≤—Ç—Ä–∞—á–∞—Ç–∏ –¥–æ—Å—Ç—É–ø, –∞–ª–µ —Ç—Ä–∞–∫—Ç—É—î–º–æ —ó—ó —è–∫ –∑–∞–≤–¥–∞–Ω–Ω—è.
        // –î–ª—è —á–∏—Å—Ç–æ—Ç–∏ –∫—Ä–∞—â–µ –±—É–ª–æ –± 'tasks', –∞–ª–µ —Ç–æ–¥—ñ –≤—Ç—Ä–∞—Ç–∏–º–æ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ. 
        // –î–∞–≤–∞–π —Å—Ç–≤–æ—Ä–∏–º–æ –ù–û–í–£ –∫–æ–ª–µ–∫—Ü—ñ—é 'tasks' –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É.
        
        onSnapshot(query(collection(db, "tasks"), orderBy("timestamp", "desc")), (snapshot) => {
            allTasks = [];
            snapshot.forEach(doc => allTasks.push({ id: doc.id, ...doc.data() }));
            renderTasks();
        });

        window.filterCat = (cat, btn) => {
            currentFilter = cat;
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderTasks();
        };

        function renderTasks() {
            const container = document.getElementById('tasks-feed');
            container.innerHTML = '';
            
            const filtered = currentFilter === 'all' ? allTasks : allTasks.filter(t => t.category === currentFilter);

            if(filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">–ó–∞–≤–¥–∞–Ω—å —É —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ–∫–∏ –Ω–µ–º–∞—î.<br>–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à–µ!</div>';
                return;
            }

            filtered.forEach(task => {
                const isMyTask = currentUser && task.uid === currentUser.uid;
                // –ö–Ω–æ–ø–∫–∞ –¥—ñ—ó
                let actionBtn = '';
                if (isMyTask) {
                    actionBtn = `<button onclick="deleteTask('${task.id}')" style="color:red; background:none; border:none; cursor:pointer;">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>`;
                } else {
                    // –Ø–∫—â–æ —î —Ç–µ–ª–µ—Ñ–æ–Ω - –¥–∑–≤–æ–Ω–∏–º–æ, —è–∫—â–æ –Ω—ñ - –ø—Ä–æ—Å—Ç–æ –∫–Ω–æ–ø–∫–∞
                    const link = task.phone ? `tel:${task.phone}` : '#';
                    const text = task.phone ? `üìû –ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏` : `‚úâÔ∏è –í—ñ–¥–≥—É–∫–Ω—É—Ç–∏—Å—è`;
                    actionBtn = `<a href="${link}" class="btn-respond" onclick="if('${link}'==='#') alert('–ó–∞–º–æ–≤–Ω–∏–∫ –Ω–µ –∑–∞–ª–∏—à–∏–≤ —Ç–µ–ª–µ—Ñ–æ–Ω. –¢—Ä–µ–±–∞ –ø–∏—Å–∞—Ç–∏ –≤ —á–∞—Ç (–≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ)')">${text}</a>`;
                }

                const html = `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-title">${task.title}</div>
                            <div class="task-price">${task.price} ‚Ç¥</div>
                        </div>
                        <div class="task-meta">
                            <span>üìÇ ${task.category}</span>
                            <span>üìç ${task.location ? '–ù–∞ –º–∞–ø—ñ' : '–ë–µ–∑ –ª–æ–∫–∞—Ü—ñ—ó'}</span>
                            <span>‚è±Ô∏è ${timeAgo(task.timestamp)}</span>
                        </div>
                        <div class="task-desc">${task.description}</div>
                        
                        <div class="task-footer">
                            <div class="author-info">
                                <img src="${task.authorPhoto || 'icon.png'}" class="author-avatar">
                                <span>${task.author}</span>
                            </div>
                            ${actionBtn}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- CREATE TASK ---
        window.getLocation = () => {
            document.getElementById('location-btn').innerText = "‚è≥ –í–∏–∑–Ω–∞—á–∞—î–º–æ...";
            navigator.geolocation.getCurrentPosition(pos => {
                taskLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                document.getElementById('location-btn').innerText = "‚úÖ –õ–æ–∫–∞—Ü—ñ—é –¥–æ–¥–∞–Ω–æ";
                document.getElementById('location-btn').classList.add('active');
            }, err => alert("–ü–æ–º–∏–ª–∫–∞ GPS"));
        };

        window.createTask = async () => {
            const title = document.getElementById('task-title').value;
            const cat = document.getElementById('task-cat').value;
            const price = document.getElementById('task-price').value;
            const desc = document.getElementById('task-desc').value;

            if(!title || !price) { alert("–í–∫–∞–∂—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ —Ü—ñ–Ω—É!"); return; }

            await addDoc(collection(db, "tasks"), {
                title, category: cat, price, description: desc,
                location: taskLocation,
                uid: currentUser.uid, author: userData.name || currentUser.displayName, 
                authorPhoto: currentUser.photoURL,
                phone: userData.phone || "", // –î–æ–¥–∞—î–º–æ —Ç–µ–ª–µ—Ñ–æ–Ω –∞–≤—Ç–æ—Ä–∞ –¥–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                timestamp: serverTimestamp()
            });

            window.toggleModal('task-modal', false);
            // –û—á–∏—Å—Ç–∫–∞
            document.getElementById('task-title').value = '';
            document.getElementById('task-desc').value = '';
            document.getElementById('task-price').value = '';
            taskLocation = null;
            document.getElementById('location-btn').innerText = "üìç –î–æ–¥–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é (GPS)";
            document.getElementById('location-btn').classList.remove('active');
        };

        window.deleteTask = (id) => confirm("–í–∏–¥–∞–ª–∏—Ç–∏?") && deleteDoc(doc(db, "tasks", id));

        // --- MAP ---
        function initMap() {
            setTimeout(() => {
                if(!map) {
                    map = L.map('map').setView([49.0, 31.0], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                }
                map.invalidateSize();
                
                // –†–µ–Ω–¥–µ—Ä –º–∞—Ä–∫–µ—Ä—ñ–≤
                map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
                
                allTasks.forEach(t => {
                    if(t.location) {
                        L.marker([t.location.lat, t.location.lng]).addTo(map)
                            .bindPopup(`<b>${t.title}</b><br>${t.price} –≥—Ä–Ω<br>${t.category}`);
                    }
                });
            }, 100);
        }

        // --- PROFILE EDIT ---
        window.openEditModal = () => {
            document.getElementById('edit-name').value = userData.name || "";
            document.getElementById('edit-phone').value = userData.phone || "";
            document.getElementById('edit-skills').value = userData.skills || "";
            toggleModal('edit-modal', true);
        };

        window.saveProfile = async () => {
            const updates = {
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value,
                skills: document.getElementById('edit-skills').value
            };
            userData = { ...userData, ...updates }; // Update local
            await updateDoc(doc(db, "users", currentUser.uid), updates);
            toggleModal('edit-modal', false);
            openProfile(); // Refresh view
        };
        
        window.signOutAndReload = async () => {
            await signOut(auth);
            location.reload();
        };

        // Helpers
        window.toggleModal = (id, show) => document.getElementById(id).classList.toggle('open', show);
        function timeAgo(ts) {
            if(!ts) return '...';
            const diff = (Date.now() - ts.toDate()) / 1000;
            if(diff < 3600) return Math.floor(diff/60) + " —Ö–≤";
            if(diff < 86400) return Math.floor(diff/3600) + " –≥–æ–¥";
            return Math.floor(diff/86400) + " –¥–Ω";
        }
    </script>
</body>
</html>
