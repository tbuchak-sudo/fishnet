<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FishNet ‚Äî –ö–ª—É–± —Ä–∏–±–∞–ª–æ–∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lake: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 800: '#075985', 900: '#0c4a6e' },
                        weed: { 500: '#22c55e', 700: '#15803d' }
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.5); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(30, 41, 59, 0.9); color: white; padding: 12px 20px; border-radius: 50px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-size: 14px; font-weight: 500; display: flex; items-center; gap: 10px; backdrop-filter: blur(4px); animation: slideUpToast 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; justify-content: center; }
        @keyframes slideUpToast { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Floating Action Button */
        .fab { position: fixed; bottom: 24px; right: 24px; z-index: 40; box-shadow: 0 4px 20px rgba(21, 128, 61, 0.4); }
    </style>
</head>
<body class="text-slate-800 antialiased h-full">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Navigation -->
    <nav class="glass-nav sticky top-0 z-40 px-4 py-3 shadow-sm transition-all duration-300" id="navbar">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center gap-2 cursor-pointer group select-none" onclick="window.resetFilter()">
                <div class="bg-gradient-to-br from-green-600 to-emerald-500 w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg shadow-green-600/20 group-hover:rotate-6 transition duration-300">
                    <i class="fas fa-fish text-lg"></i>
                </div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight"><span class="text-green-700">Fish</span>Net</h1>
            </div>
            
            <!-- Auth / Profile -->
            <div class="flex items-center gap-3">
                <div id="user-info" class="hidden flex items-center gap-2">
                    <div class="text-right hidden sm:block">
                        <p id="my-name" class="font-bold text-xs text-slate-700 leading-none mb-1">...</p>
                        <button onclick="window.logout()" class="text-[10px] text-red-500 font-bold hover:underline">–í–ò–ô–¢–ò</button>
                    </div>
                    <img id="my-avatar" src="" class="w-9 h-9 rounded-full border-2 border-white shadow-md bg-slate-200 object-cover cursor-pointer hover:scale-105 transition" onclick="window.logout()" title="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –≤–∏–π—Ç–∏">
                </div>
                
                <button id="login-btn" onclick="openAuthModal()" class="bg-slate-900 text-white px-5 py-2 rounded-full text-xs font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-900/20 hidden">
                    –í—Ö—ñ–¥
                </button>
            </div>
        </div>
    </nav>

    <!-- Filters Bar (Horizontal Scroll) -->
    <div class="bg-white border-b border-slate-200 sticky top-[65px] z-30 py-2 shadow-sm">
        <div class="max-w-3xl mx-auto px-4 overflow-x-auto hide-scrollbar flex gap-2" id="filter-container">
            <button onclick="window.filterPosts('all')" id="filter-all" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white shadow-md transition-all">
                –í—Å—ñ
            </button>
            <!-- Tags injected by JS -->
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-xl mx-auto mt-4 px-4 pb-32 space-y-5">
        
        <!-- Desktop Create Box -->
        <div id="create-post-box" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 hidden sm:block hover:shadow-md transition cursor-pointer" onclick="openModal()">
            <div class="flex gap-3 items-center">
                <img id="post-avatar-mini" src="" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-100">
                <div class="flex-1 bg-slate-100 hover:bg-slate-50 border border-transparent hover:border-slate-200 rounded-full h-10 flex items-center px-4 text-slate-400 text-sm transition">
                    –ù–∞ —â–æ –∫–ª—é–≤–∞–ª–æ —Å—å–æ–≥–æ–¥–Ω—ñ?
                </div>
                <div class="text-green-600 bg-green-50 p-2 rounded-full w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
        </div>
        
        <!-- Guest Banner -->
        <div id="guest-banner" class="hidden bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-2xl text-white shadow-lg shadow-blue-600/20 relative overflow-hidden">
            <i class="fas fa-water absolute -bottom-4 -right-4 text-8xl text-white/10"></i>
            <div class="relative z-10">
                <h3 class="font-bold text-lg mb-1">–°–ø—ñ–ª—å–Ω–æ—Ç–∞ —Ä–∏–±–∞–ª–æ–∫</h3>
                <p class="text-blue-100 text-sm mb-4 max-w-xs">–î—ñ–ª—ñ—Ç—å—Å—è —Ç—Ä–æ—Ñ–µ—è–º–∏, –∑–Ω–∞—Ö–æ–¥—å—Ç–µ —Ä–∏–±–Ω—ñ –º—ñ—Å—Ü—è —Ç–∞ —Å–ø—ñ–ª–∫—É–π—Ç–µ—Å—å –∑ –æ–¥–Ω–æ–¥—É–º—Ü—è–º–∏.</p>
                <button onclick="openAuthModal()" class="bg-white text-blue-700 px-6 py-2 rounded-full text-sm font-bold hover:shadow-lg hover:scale-105 transition">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
            </div>
        </div>

        <!-- Filter Status -->
        <div id="filter-status" class="hidden items-center justify-between bg-green-50 text-green-800 px-4 py-2 rounded-lg text-sm font-medium border border-green-100">
            <span>–§—ñ–ª—å—Ç—Ä: <b id="active-filter-name">–©—É–∫–∞</b></span>
            <button onclick="window.resetFilter()" class="text-green-600 hover:text-green-800"><i class="fas fa-times"></i></button>
        </div>

        <!-- Posts Feed -->
        <div id="posts-container" class="space-y-5 min-h-[300px]">
            <div class="flex flex-col items-center justify-center py-20 text-slate-400 gap-3">
                <i class="fas fa-circle-notch fa-spin fa-2x text-green-500"></i>
                <span class="text-sm font-medium">–ó–∞–∫–∏–¥–∞—î–º–æ –≤—É–¥–∫–∏...</span>
            </div>
        </div>

    </main>

    <!-- Mobile FAB (Create Post) -->
    <button id="fab-create" onclick="openModal()" class="fab hidden sm:hidden w-14 h-14 bg-green-600 text-white rounded-full flex items-center justify-center text-xl hover:bg-green-700 hover:scale-110 active:scale-95 transition duration-300">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Create Post Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-all duration-300 opacity-0" style="transition: opacity 0.3s;">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden transform scale-95 transition-all duration-300" id="modal-content">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="font-bold text-lg text-slate-800">–ù–æ–≤–∏–π –∑–≤—ñ—Ç</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-5 space-y-4">
                <!-- Tags Selection -->
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">–ö–æ–≥–æ —Å–ø—ñ–π–º–∞–ª–∏?</label>
                    <div class="flex flex-wrap gap-2" id="modal-tags"></div>
                    <input type="hidden" id="selected-tag" value="–Ü–Ω—à–µ">
                </div>

                <textarea id="post-text" rows="3" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-green-500 focus:bg-white transition resize-none text-base" placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Ä–∏–±–∞–ª–∫—É: –≤–∞–≥–∞, –Ω–∞–∂–∏–≤–∫–∞, –º—ñ—Å—Ü–µ..."></textarea>
                
                <!-- Image Input & Preview -->
                <div class="space-y-2">
                    <div class="relative group">
                        <i class="fas fa-link absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="post-image-url" oninput="previewImage(this.value)" placeholder="–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ (URL)" class="w-full bg-slate-50 border-none rounded-xl py-3 pl-10 pr-4 text-sm focus:ring-2 focus:ring-green-500 focus:bg-white transition">
                    </div>
                    <!-- Image Preview Container -->
                    <div id="image-preview-box" class="hidden rounded-xl overflow-hidden border border-slate-200 bg-slate-100 relative h-48 w-full">
                        <img id="img-preview-el" src="" class="w-full h-full object-cover">
                        <button onclick="clearImage()" class="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white rounded-full w-6 h-6 flex items-center justify-center backdrop-blur-md"><i class="fas fa-times text-xs"></i></button>
                    </div>
                    <p class="text-[10px] text-slate-400 px-2">–ü–æ—Ä–∞–¥–∞: –°–∫–æ–ø—ñ—é–π—Ç–µ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑ Google Images –∞–±–æ —Ñ–æ—Ç–æ—Ö–æ—Å—Ç–∏–Ω–≥—É.</p>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                <button id="btn-publish" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</span>
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center z-[60] p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden transform scale-95 transition-transform" id="auth-content">
            <div class="relative h-32 bg-slate-900 overflow-hidden flex items-center justify-center">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <i class="fas fa-fish text-6xl text-white/20 absolute -right-4 -bottom-4 rotate-12"></i>
                <h2 class="text-2xl font-black text-white relative z-10">FishNet ID</h2>
                <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-white/50 hover:text-white transition"><i class="fas fa-times fa-lg"></i></button>
            </div>

            <div class="p-6">
                <!-- Tabs -->
                <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
                    <button onclick="switchTab('login')" id="tab-login" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white text-slate-800 shadow-sm transition-all">–í—Ö—ñ–¥</button>
                    <button onclick="switchTab('register')" id="tab-register" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                </div>

                <div id="auth-error" class="hidden bg-red-50 text-red-600 text-xs p-3 rounded-xl border border-red-100 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i> <span id="auth-error-text">Error</span>
                </div>

                <div class="space-y-3 mb-6">
                    <input type="email" id="auth-email" placeholder="Email" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 outline-none focus:border-green-500 focus:bg-white transition text-sm font-medium text-slate-700">
                    <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 px-4 outline-none focus:border-green-500 focus:bg-white transition text-sm font-medium text-slate-700">
                </div>

                <button id="auth-submit-btn" onclick="handleAuth()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-green-600/30 active:scale-95 mb-4">
                    –£–≤—ñ–π—Ç–∏
                </button>

                <div class="relative flex py-2 items-center mb-4">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-300 text-xs uppercase font-bold">–∞–±–æ</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <button onclick="handleGoogleAuth()" class="w-full bg-white border border-slate-200 text-slate-700 py-2.5 rounded-xl font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2 mb-2">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                    <span class="text-sm">Google</span>
                </button>
                
                <button onclick="handleGuest()" class="w-full py-2 text-xs font-bold text-slate-400 hover:text-green-600 transition">
                    –ü–†–û–î–û–í–ñ–ò–¢–ò –Ø–ö –ì–Ü–°–¢–¨
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, increment, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fishnet-v2';

        // CONSTANTS
        const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
        const commentsCol = collection(db, 'artifacts', appId, 'public', 'data', 'comments');
        
        const FISH_TAGS = [
            { id: '–Ü–Ω—à–µ', icon: 'fa-question', color: 'bg-slate-100 text-slate-600 border-slate-200' },
            { id: '–©—É–∫–∞', icon: 'fa-dragon', color: 'bg-green-50 text-green-700 border-green-200' },
            { id: '–û–∫—É–Ω—å', icon: 'fa-fish-fins', color: 'bg-orange-50 text-orange-700 border-orange-200' },
            { id: '–ö–æ—Ä–æ–ø', icon: 'fa-layer-group', color: 'bg-yellow-50 text-yellow-700 border-yellow-200' },
            { id: '–°—É–¥–∞–∫', icon: 'fa-bolt', color: 'bg-blue-50 text-blue-700 border-blue-200' },
            { id: '–°–æ–º', icon: 'fa-frog', color: 'bg-purple-50 text-purple-700 border-purple-200' },
            { id: '–ö–∞—Ä–∞—Å—å', icon: 'fa-circle', color: 'bg-amber-50 text-amber-700 border-amber-200' },
        ];

        // STATE
        let currentUser = null;
        let isRegisterMode = false;
        let allPostsCache = [];
        let currentFilter = 'all';

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUI(user);
        });

        function updateUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const createBox = document.getElementById('create-post-box');
            const guestBanner = document.getElementById('guest-banner');
            const fab = document.getElementById('fab-create');

            if (user) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                createBox.classList.remove('hidden'); // Show desktop creator
                if(window.innerWidth < 640) fab.classList.remove('hidden'); // Show mobile FAB
                guestBanner.classList.add('hidden');
                
                const name = user.displayName || (user.isAnonymous ? `–ì—ñ—Å—Ç—å` : (user.email.split('@')[0]));
                document.getElementById('my-name').innerText = name.length > 15 ? name.substring(0,15)+'...' : name;
                
                let avatar = user.photoURL;
                if (!avatar) {
                    const seed = user.isAnonymous ? user.uid : (user.email || user.uid);
                    avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=e0f2fe`;
                }
                document.getElementById('my-avatar').src = avatar;
                document.getElementById('post-avatar-mini').src = avatar;
                
                closeAuthModal();
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
                createBox.classList.add('hidden');
                fab.classList.add('hidden');
                guestBanner.classList.remove('hidden');
            }
        }

        window.handleGoogleAuth = async () => {
            try { await signInWithPopup(auth, googleProvider); showToast('–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!', 'success'); } 
            catch (e) { showToast("–ü–æ–º–∏–ª–∫–∞ Google: " + e.message, 'error'); }
        };

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            const btn = document.getElementById('auth-submit-btn');

            if(!email || !pass) return showAuthError("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è");

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                if (isRegisterMode) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
                showToast(isRegisterMode ? "–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ!" : "–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º!", 'success');
            } catch (e) {
                let msg = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó";
                if(e.code?.includes('email-already-in-use')) msg = "–¶—è –ø–æ—à—Ç–∞ –≤–∂–µ –∑–∞–π–Ω—è—Ç–∞";
                if(e.code?.includes('invalid-credential')) msg = "–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å";
                if(e.code?.includes('weak-password')) msg = "–ü–∞—Ä–æ–ª—å –Ω–∞–¥—Ç–æ –ø—Ä–æ—Å—Ç–∏–π";
                showAuthError(msg);
            } finally {
                btn.disabled = false;
                btn.innerText = isRegisterMode ? "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è" : "–£–≤—ñ–π—Ç–∏";
            }
        };

        window.handleGuest = async () => { await signInAnonymously(auth); showToast("–í—Ö—ñ–¥ —è–∫ –ì—ñ—Å—Ç—å", 'info'); };
        window.logout = async () => { await signOut(auth); showToast("–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–∫–∞—É–Ω—Ç—É", 'info'); location.reload(); };

        function showAuthError(msg) {
            const errorBox = document.getElementById('auth-error');
            document.getElementById('auth-error-text').innerText = msg;
            errorBox.classList.remove('hidden');
        }

        // --- POSTS LOGIC ---
        // Initialize Feed
        const q = query(postsCol);
        onSnapshot(q, (snapshot) => {
            allPostsCache = [];
            snapshot.forEach(doc => allPostsCache.push({ id: doc.id, ...doc.data() }));
            // Client side sort for smoother updates without index errors
            allPostsCache.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            renderPosts();
        });

        function renderPosts() {
            const container = document.getElementById('posts-container');
            
            // Filter Logic
            const filtered = currentFilter === 'all' 
                ? allPostsCache 
                : allPostsCache.filter(p => p.tag === currentFilter);

            // Filter UI State
            const filterStatus = document.getElementById('filter-status');
            const activeFilterName = document.getElementById('active-filter-name');
            const filterButtons = document.querySelectorAll('#filter-container button');
            
            filterButtons.forEach(btn => {
                if(btn.id === `filter-${currentFilter}`) {
                    btn.classList.remove('bg-white', 'text-slate-600');
                    btn.classList.add('bg-slate-800', 'text-white');
                } else {
                    btn.classList.add('bg-white', 'text-slate-600');
                    btn.classList.remove('bg-slate-800', 'text-white');
                }
            });

            if(currentFilter !== 'all') {
                filterStatus.classList.replace('hidden', 'flex');
                activeFilterName.innerText = currentFilter;
            } else {
                filterStatus.classList.replace('flex', 'hidden');
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 opacity-60 animate-fade-in">
                        <i class="fas fa-fish fa-3x mb-4 text-slate-300"></i>
                        <p class="text-slate-500 font-medium">–¢—É—Ç –ø–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ.</p>
                        ${currentFilter !== 'all' ? '<button onclick="window.resetFilter()" class="text-green-600 font-bold mt-2 hover:underline">–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>' : ''}
                    </div>`;
                return;
            }

            // Render
            container.innerHTML = filtered.map(post => {
                const isOwner = currentUser && post.userId === currentUser.uid;
                const timeAgo = getTimeAgo(post.createdAt?.seconds);
                const tagConfig = FISH_TAGS.find(t => t.id === post.tag) || FISH_TAGS[0];
                const avatar = post.userPhoto || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.userEmail || post.userId}&backgroundColor=e0f2fe`;

                return `
                <article class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden animate-slide-up group">
                    <div class="p-4 flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <img src="${avatar}" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-white shadow-sm">
                            <div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-bold text-slate-800 text-sm">${escapeHtml(post.userName || '–†–∏–±–∞–ª–∫–∞')}</span>
                                    <button onclick="window.filterPosts('${post.tag}')" class="text-[10px] px-2 py-0.5 rounded-md font-bold uppercase tracking-wider border ${tagConfig.color} hover:brightness-95 transition">
                                        <i class="fas ${tagConfig.icon || 'fa-fish'} mr-1 opacity-50"></i>${post.tag}
                                    </button>
                                </div>
                                <span class="text-xs text-slate-400 block mt-0.5">${timeAgo}</span>
                            </div>
                        </div>
                        ${isOwner ? `<button onclick="deletePost('${post.id}')" class="text-slate-300 hover:text-red-500 transition p-2 hover:bg-red-50 rounded-full"><i class="far fa-trash-alt"></i></button>` : ''}
                    </div>
                    
                    <div class="px-4 pb-3">
                        <p class="text-slate-700 whitespace-pre-wrap leading-relaxed text-[15px]">${escapeHtml(post.content)}</p>
                    </div>

                    ${post.imageUrl ? `
                        <div class="bg-slate-50 relative overflow-hidden group-hover:brightness-[1.02] transition duration-500">
                            <img src="${escapeHtml(post.imageUrl)}" class="w-full h-auto max-h-[500px] object-cover" loading="lazy" onerror="this.parentElement.style.display='none'">
                        </div>
                    ` : ''}

                    <div class="p-3 grid grid-cols-2 gap-2">
                        <button id="like-btn-${post.id}" onclick="window.like('${post.id}')" class="flex justify-center items-center gap-2 text-slate-500 hover:text-red-500 transition py-2 rounded-xl hover:bg-red-50 active:scale-95">
                            <i class="${post.likes > 0 ? 'fas text-red-500 animate-bounce-short' : 'far'} fa-heart text-lg"></i>
                            <span class="font-bold text-sm">${post.likes || 0}</span>
                        </button>
                        
                        <button onclick="toggleComments('${post.id}')" class="flex justify-center items-center gap-2 text-slate-500 hover:text-blue-600 transition py-2 rounded-xl hover:bg-blue-50 active:scale-95">
                            <i class="far fa-comment-dots text-lg"></i>
                            <span class="font-bold text-sm">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</span>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div id="comments-${post.id}" class="hidden bg-slate-50/50 border-t border-slate-100 p-4">
                        <div id="comments-list-${post.id}" class="space-y-3 mb-4 max-h-60 overflow-y-auto hide-scrollbar">
                            <p class="text-xs text-slate-400 text-center py-2">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                        </div>
                        <form onsubmit="postComment(event, '${post.id}')" class="relative">
                            <input type="text" name="commentText" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä..." class="w-full bg-white border border-slate-200 rounded-full py-3 pl-4 pr-12 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none shadow-sm transition">
                            <button type="submit" class="absolute right-1.5 top-1.5 text-blue-600 hover:bg-blue-50 p-2 rounded-full transition w-9 h-9 flex items-center justify-center">
                                <i class="fas fa-paper-plane text-xs"></i>
                            </button>
                        </form>
                    </div>
                </article>
                `;
            }).join('');
        }

        window.filterPosts = (tag) => { 
            if(tag === 'all') currentFilter = 'all';
            else currentFilter = tag;
            renderPosts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        window.resetFilter = () => window.filterPosts('all');

        // --- ACTIONS ---
        window.like = async (id) => {
            if (!currentUser) { openAuthModal(); return; }
            // Optimistic UI update handled by re-render from Firestore snapshot mostly, 
            // but we can add visual feedback immediately if needed.
            // Here we just trigger firestore.
            const ref = doc(postsCol, id);
            await updateDoc(ref, { likes: increment(1) });
        };

        window.deletePost = async (id) => {
            if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–≤—ñ—Ç?")) return;
            try { await deleteDoc(doc(postsCol, id)); showToast("–ó–≤—ñ—Ç –≤–∏–¥–∞–ª–µ–Ω–æ", 'info'); } 
            catch(e) { console.error(e); showToast("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è", 'error'); }
        };

        // Comments System
        let commentUnsubscribes = {};

        window.toggleComments = (postId) => {
            const section = document.getElementById(`comments-${postId}`);
            const isHidden = section.classList.contains('hidden');
            
            if (isHidden) {
                section.classList.remove('hidden');
                loadComments(postId);
            } else {
                section.classList.add('hidden');
                if (commentUnsubscribes[postId]) {
                    commentUnsubscribes[postId](); // Stop listening
                    delete commentUnsubscribes[postId];
                }
            }
        };

        function loadComments(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            const q = query(commentsCol, where("postId", "==", postId));
            
            commentUnsubscribes[postId] = onSnapshot(q, (snapshot) => {
                const comments = [];
                snapshot.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
                comments.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                if (comments.length === 0) {
                    list.innerHTML = `<p class="text-xs text-slate-400 text-center italic py-2">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤. –ù–∞–ø–∏—à—ñ—Ç—å –ø–µ—Ä—à–∏–π!</p>`;
                    return;
                }

                list.innerHTML = comments.map(c => {
                    const cAvatar = c.userPhoto || `https://api.dicebear.com/7.x/avataaars/svg?seed=${c.userSeed || 'guest'}&backgroundColor=e0f2fe`;
                    return `
                    <div class="flex gap-2 text-sm animate-fade-in group">
                        <img src="${cAvatar}" class="w-7 h-7 rounded-full bg-white border border-slate-200 flex-shrink-0 object-cover mt-1">
                        <div class="bg-white px-3 py-2 rounded-2xl rounded-tl-none border border-slate-100 shadow-sm max-w-[90%] relative">
                            <p class="font-bold text-[11px] text-slate-500 mb-0.5">${escapeHtml(c.userName)}</p>
                            <p class="text-slate-800 leading-snug text-sm">${escapeHtml(c.text)}</p>
                        </div>
                    </div>
                `}).join('');
                list.scrollTop = list.scrollHeight;
            });
        }

        window.postComment = async (e, postId) => {
            e.preventDefault();
            const input = e.target.commentText;
            const text = input.value.trim();
            if (!currentUser) { showToast("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏", 'error'); openAuthModal(); return; }
            if (!text) return;

            const name = currentUser.displayName || (currentUser.isAnonymous ? `–ì—ñ—Å—Ç—å` : (currentUser.email.split('@')[0]));
            
            try {
                input.value = '';
                await addDoc(commentsCol, {
                    postId: postId,
                    userId: currentUser.uid,
                    userName: name,
                    userPhoto: currentUser.photoURL || null,
                    userSeed: currentUser.isAnonymous ? currentUser.uid : currentUser.email,
                    text: text,
                    createdAt: serverTimestamp()
                });
            } catch (err) { console.error(err); input.value = text; showToast("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏", 'error'); }
        };

        // --- CREATE POST ---
        document.getElementById('btn-publish').onclick = async () => {
            const text = document.getElementById('post-text').value;
            const img = document.getElementById('post-image-url').value;
            const tag = document.getElementById('selected-tag').value;
            const btn = document.getElementById('btn-publish');
            
            if (!text) return showToast("–ù–∞–ø–∏—à—ñ—Ç—å —Ö–æ—á —â–æ—Å—å...", 'error');
            if (!currentUser) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const name = currentUser.displayName || (currentUser.isAnonymous ? `–ì—ñ—Å—Ç—å` : (currentUser.email.split('@')[0]));
                await addDoc(postsCol, {
                    userId: currentUser.uid,
                    userName: name,
                    userEmail: currentUser.email || 'guest',
                    userPhoto: currentUser.photoURL || null,
                    content: text,
                    imageUrl: img,
                    tag: tag,
                    likes: 0,
                    createdAt: serverTimestamp()
                });
                
                document.getElementById('post-text').value = '';
                clearImage();
                closeModal();
                showToast("–ó–≤—ñ—Ç –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ! üé£", 'success');
                window.resetFilter(); // Show new post
            } catch (e) { showToast("–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó", 'error'); } 
            finally { 
                btn.disabled = false; 
                btn.innerHTML = '<span>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</span><i class="fas fa-paper-plane text-xs"></i>'; 
            }
        };

        // --- UTILS ---
        window.previewImage = (url) => {
            const box = document.getElementById('image-preview-box');
            const img = document.getElementById('img-preview-el');
            if(url.trim().length > 4) {
                box.classList.remove('hidden');
                img.src = url;
                img.onerror = () => { box.classList.add('hidden'); };
            } else {
                box.classList.add('hidden');
            }
        };

        window.clearImage = () => {
            document.getElementById('post-image-url').value = '';
            document.getElementById('image-preview-box').classList.add('hidden');
            document.getElementById('img-preview-el').src = '';
        }

        window.showToast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            let icon = type === 'success' ? 'check-circle text-green-400' : (type === 'error' ? 'exclamation-circle text-red-400' : 'info-circle text-blue-400');
            toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        function getTimeAgo(seconds) {
            if (!seconds) return '—â–æ–π–Ω–æ';
            const diff = Math.floor(Date.now() / 1000) - seconds;
            if (diff < 60) return '—â–æ–π–Ω–æ';
            if (diff < 3600) return `${Math.floor(diff/60)} —Ö–≤`;
            if (diff < 86400) return `${Math.floor(diff/3600)} –≥–æ–¥`;
            return `${Math.floor(diff/86400)} –¥–Ω`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- INIT ---
        // Render Filters/Tags
        const filterContainer = document.getElementById('filter-container');
        const modalTags = document.getElementById('modal-tags');
        
        FISH_TAGS.forEach(tag => {
            // Filter Bar Buttons
            if(tag.id !== '–Ü–Ω—à–µ') {
                const btn = document.createElement('button');
                btn.id = `filter-${tag.id}`;
                btn.className = `flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 shadow-sm border border-slate-100 transition-all hover:bg-slate-50`;
                btn.onclick = () => window.filterPosts(tag.id);
                btn.innerText = tag.id;
                filterContainer.appendChild(btn);
            }

            // Modal Selection Buttons
            const modalBtn = document.createElement('button');
            modalBtn.className = `px-3 py-2 rounded-xl text-xs font-bold border ${tag.color.replace('bg-', 'hover:bg-')} bg-white text-slate-500 transition-all flex items-center gap-2`;
            if(tag.id === '–Ü–Ω—à–µ') modalBtn.classList.add('ring-2', 'ring-offset-1', 'ring-slate-300'); // Default active styling (simplified)
            
            modalBtn.innerHTML = `<i class="fas ${tag.icon}"></i> ${tag.id}`;
            modalBtn.onclick = () => {
                Array.from(modalTags.children).forEach(c => c.className = `px-3 py-2 rounded-xl text-xs font-bold border border-slate-200 bg-white text-slate-500 transition-all flex items-center gap-2 hover:bg-slate-50`);
                modalBtn.className = `px-3 py-2 rounded-xl text-xs font-bold border bg-white flex items-center gap-2 ring-2 ring-offset-1 ring-green-500 text-green-700 shadow-sm transform scale-105 transition-all`;
                document.getElementById('selected-tag').value = tag.id;
            };
            modalTags.appendChild(modalBtn);
        });

        // Modal Controls with Animation
        window.openModal = () => {
            if(!currentUser) { openAuthModal(); return; }
            const m = document.getElementById('modal');
            m.classList.remove('hidden', 'flex');
            m.classList.add('flex');
            // Trigger reflow
            void m.offsetWidth; 
            m.classList.remove('opacity-0');
            document.getElementById('modal-content').classList.remove('scale-95');
            document.getElementById('modal-content').classList.add('scale-100');
        }
        window.closeModal = () => {
            const m = document.getElementById('modal');
            m.classList.add('opacity-0');
            document.getElementById('modal-content').classList.remove('scale-100');
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => m.classList.replace('flex', 'hidden'), 300);
        }
        window.openAuthModal = () => {
            const m = document.getElementById('auth-modal');
            m.classList.remove('hidden', 'flex');
            m.classList.add('flex');
            void m.offsetWidth;
            m.classList.remove('opacity-0');
            document.getElementById('auth-content').classList.remove('scale-95');
        }
        window.closeAuthModal = () => {
             const m = document.getElementById('auth-modal');
             m.classList.add('opacity-0');
             document.getElementById('auth-content').classList.add('scale-95');
             setTimeout(() => m.classList.replace('flex', 'hidden'), 300);
        }

        window.switchTab = (mode) => {
            const loginTab = document.getElementById('tab-login');
            const regTab = document.getElementById('tab-register');
            const btn = document.getElementById('auth-submit-btn');
            document.getElementById('auth-error').classList.add('hidden');
            
            if(mode === 'register') {
                isRegisterMode = true;
                regTab.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white text-slate-800 shadow-sm transition-all";
                loginTab.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all";
                btn.innerText = "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è";
            } else {
                isRegisterMode = false;
                loginTab.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white text-slate-800 shadow-sm transition-all";
                regTab.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all";
                btn.innerText = "–£–≤—ñ–π—Ç–∏";
            }
        };
    </script>
</body>
</html>
