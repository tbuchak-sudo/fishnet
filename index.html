<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FishNet ‚Äî –ö–ª—É–± —Ç—Ä–æ—Ñ–µ–π–Ω–æ—ó —Ä–∏–±–∞–ª–∫–∏</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 800: '#166534', 900: '#14532d' },
                        water: { 500: '#0ea5e9', 900: '#0c4a6e' },
                        surface: '#ffffff',
                        dark: '#0f172a'
                    },
                    animation: {
                        'like-bounce': 'likeBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        likeBounce: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.4)' }, '100%': { transform: 'scale(1)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(15px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism Utilities */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.3); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); }

        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(20px); opacity: 0; transition: all 0.3s ease; }

        /* Mobile specific bottom padding */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body class="text-slate-800 antialiased h-full">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-sm px-4 pointer-events-none"></div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 transition-all duration-300" id="header">
        <div class="max-w-2xl mx-auto px-4 h-16 flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center gap-2.5 cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <div class="relative w-9 h-9 flex items-center justify-center bg-gradient-to-tr from-brand-600 to-emerald-400 rounded-xl text-white shadow-lg shadow-brand-500/30">
                    <i class="fas fa-fish text-lg transform -rotate-12"></i>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">Fish<span class="text-brand-600">Net</span></h1>
            </div>

            <!-- Profile / Auth -->
            <div class="flex items-center gap-3">
                <div id="auth-section" class="flex items-center gap-2">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>

        <!-- Weather Widget (Mock) & Filters -->
        <div class="border-t border-slate-200/50 bg-white/50 backdrop-blur-md">
            <div class="max-w-2xl mx-auto">
                <div class="flex items-center px-4 py-2 gap-3 overflow-x-auto hide-scrollbar" id="filters-container">
                    <!-- Weather Pill -->
                    <div class="flex-shrink-0 flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-xs font-semibold border border-blue-100">
                        <i class="fas fa-cloud-sun text-yellow-500"></i>
                        <span>+22¬∞C ‚Ä¢ 755–º–º</span>
                    </div>
                    <div class="w-px h-6 bg-slate-300 flex-shrink-0 mx-1"></div>
                    <!-- Filter Tags injected here -->
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-2xl mx-auto px-3 sm:px-4 py-6 pb-24 space-y-6">
        
        <!-- Welcome / Stats Card (Only for Guests or Empty State) -->
        <div id="welcome-card" class="hidden relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-800 to-slate-900 p-6 text-white shadow-xl shadow-slate-900/10">
            <div class="absolute top-0 right-0 w-64 h-64 bg-brand-500/20 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
            <div class="relative z-10">
                <h2 class="text-2xl font-bold mb-2">–°–µ–∑–æ–Ω —Ç—Ä–æ—Ñ–µ—ó–≤ –≤—ñ–¥–∫—Ä–∏—Ç–æ! üé£</h2>
                <p class="text-slate-300 mb-6 max-w-sm text-sm leading-relaxed">–ü—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏ —Ä–∏–±–∞–ª–æ–∫. –î—ñ–ª–∏—Å—å —É–ª–æ–≤–æ–º, —à—É–∫–∞–π –º—ñ—Å—Ü—è —Ç–∞ —Å–ø—ñ–ª–∫—É–π—Å—è.</p>
                <div class="flex gap-3">
                    <button onclick="openAuthModal()" class="bg-brand-500 hover:bg-brand-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold transition shadow-lg shadow-brand-500/25 active:scale-95">
                        –£–≤—ñ–π—Ç–∏
                    </button>
                    <button onclick="handleGuest()" class="bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl text-sm font-bold backdrop-blur-md transition border border-white/10 active:scale-95">
                        –Ø —Ç—ñ–ª—å–∫–∏ –ø–æ–¥–∏–≤–∏—Ç–∏—Å—å
                    </button>
                </div>
            </div>
        </div>

        <!-- Feed Container -->
        <div id="posts-feed" class="space-y-6 min-h-[400px]">
            <!-- Skeleton Loader -->
            <div class="animate-pulse space-y-6" id="skeleton-loader">
                <div class="bg-white rounded-3xl p-4 h-64 shadow-sm"></div>
                <div class="bg-white rounded-3xl p-4 h-64 shadow-sm"></div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="sm:hidden fixed bottom-0 left-0 right-0 glass-card rounded-t-3xl pb-safe z-30 px-6 py-3 flex justify-between items-center shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center gap-1 text-brand-600 p-2">
            <i class="fas fa-home text-xl"></i>
        </button>
        
        <button onclick="openModal()" class="bg-brand-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-brand-600/40 transform -translate-y-6 active:scale-90 transition">
            <i class="fas fa-plus text-xl"></i>
        </button>
        
        <button onclick="openProfile()" class="flex flex-col items-center gap-1 text-slate-400 p-2 hover:text-slate-600 transition">
            <i class="fas fa-user text-xl"></i>
        </button>
    </nav>

    <!-- Desktop Create Button (Floating) -->
    <button onclick="openModal()" class="hidden sm:flex fixed bottom-8 right-8 bg-slate-900 hover:bg-slate-800 text-white px-6 py-4 rounded-full shadow-2xl items-center gap-3 transition hover:-translate-y-1 active:scale-95 z-30 group">
        <i class="fas fa-camera text-brand-400 group-hover:rotate-12 transition"></i>
        <span class="font-bold pr-1">–ù–æ–≤–∏–π –∑–≤—ñ—Ç</span>
    </button>

    <!-- Create Post Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden" role="dialog">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>
        <div class="absolute inset-x-0 bottom-0 sm:inset-0 sm:flex sm:items-center sm:justify-center p-4 pointer-events-none">
            <div class="bg-white w-full sm:max-w-lg sm:rounded-3xl rounded-t-3xl shadow-2xl transform transition-all translate-y-full sm:translate-y-10 opacity-0 pointer-events-auto flex flex-col max-h-[90vh]" id="modal-content">
                
                <!-- Header -->
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sm:rounded-t-3xl rounded-t-3xl sticky top-0 z-10">
                    <h2 class="font-bold text-lg text-slate-800">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—ñ—Ç</h2>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-400 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Scrollable Content -->
                <div class="p-6 overflow-y-auto hide-scrollbar space-y-5">
                    
                    <!-- Tags -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">–©–æ —Å–ø—ñ–π–º–∞–ª–∏?</label>
                        <div class="flex flex-wrap gap-2" id="modal-tags"></div>
                        <input type="hidden" id="selected-tag" value="–Ü–Ω—à–µ">
                    </div>

                    <!-- Text Area -->
                    <div class="relative">
                        <textarea id="post-text" rows="4" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition resize-none text-base" placeholder="–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –≤—Ä–∞–∂–µ–Ω–Ω—è–º–∏: –≤–∞–≥–∞, –Ω–∞–∂–∏–≤–∫–∞, –º—ñ—Å—Ü–µ..."></textarea>
                        <i class="fas fa-pen absolute right-4 bottom-4 text-slate-300 text-xs"></i>
                    </div>

                    <!-- Image URL Input -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">–§–æ—Ç–æ —Ç—Ä–æ—Ñ–µ—é</label>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="post-image-url" oninput="previewImage(this.value)" placeholder="–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è..." class="flex-1 bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition">
                            <button onclick="pasteFromClipboard()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-xl font-medium text-sm transition" title="–í—Å—Ç–∞–≤–∏—Ç–∏">
                                <i class="fas fa-paste"></i>
                            </button>
                        </div>
                        
                        <!-- Preview -->
                        <div id="image-preview-box" class="hidden rounded-2xl overflow-hidden bg-slate-100 border border-slate-200 relative aspect-video group">
                            <img id="img-preview-el" src="" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                <button onclick="clearImage()" class="bg-white/20 hover:bg-white/40 backdrop-blur-md text-white px-4 py-2 rounded-full text-sm font-bold transition">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-100 bg-slate-50/50 sm:rounded-b-3xl pb-safe">
                    <button id="btn-publish" onclick="submitPost()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3.5 rounded-xl font-bold text-base shadow-xl shadow-slate-900/10 flex items-center justify-center gap-2 active:scale-[0.98] transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</span>
                        <i class="fas fa-paper-plane text-xs opacity-70"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeAuthModal()"></div>
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl relative z-10 overflow-hidden transform scale-95 opacity-0 transition-all duration-300" id="auth-box">
            <div class="h-32 bg-brand-600 relative overflow-hidden flex items-center justify-center">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                <div class="text-center relative z-10 text-white">
                    <i class="fas fa-fish text-4xl mb-2 drop-shadow-md"></i>
                    <h2 class="text-xl font-bold">–í—Ö—ñ–¥ —É FishNet</h2>
                </div>
                <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-white/60 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6">
                <!-- Mode Switch -->
                <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
                    <button onclick="toggleAuthMode('login')" id="tab-login" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition-all text-slate-800">–í—Ö—ñ–¥</button>
                    <button onclick="toggleAuthMode('register')" id="tab-register" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                </div>

                <div id="auth-error" class="hidden text-red-500 text-xs text-center mb-3 font-medium bg-red-50 py-2 rounded-lg border border-red-100"></div>

                <div class="space-y-3">
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                        <input type="email" id="email" placeholder="Email" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-10 pr-4 text-sm outline-none focus:border-brand-500 focus:bg-white transition">
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-3.5 text-slate-400 text-sm"></i>
                        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-10 pr-4 text-sm outline-none focus:border-brand-500 focus:bg-white transition">
                    </div>
                </div>

                <button id="auth-action-btn" onclick="performAuth()" class="w-full mt-6 bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-brand-600/30 active:scale-95 transition">–£–≤—ñ–π—Ç–∏</button>
                
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <button onclick="handleGoogleAuth()" class="w-full bg-white border border-slate-200 text-slate-700 py-2.5 rounded-xl font-semibold hover:bg-slate-50 transition flex items-center justify-center gap-2 text-sm">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-4 h-4">
                        –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑ Google
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="fixed inset-0 z-[70] bg-black/95 hidden items-center justify-center opacity-0 transition-opacity duration-300" onclick="closeLightbox()">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white p-2"><i class="fas fa-times fa-2x"></i></button>
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] object-contain shadow-2xl rounded-sm transform scale-95 transition-transform duration-300">
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, increment, serverTimestamp, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fishnet-v2';

        const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
        const commentsCol = collection(db, 'artifacts', appId, 'public', 'data', 'comments');

        // --- State ---
        let currentUser = null;
        let isRegister = false;
        let currentFilter = '–í—Å—ñ';
        let postsCache = [];
        let postsUnsub = null;

        const TAGS = [
            { id: '–í—Å—ñ', color: 'bg-slate-800 text-white' },
            { id: '–©—É–∫–∞', color: 'bg-teal-50 text-teal-700 border-teal-200 hover:bg-teal-100', icon: 'fa-dragon' },
            { id: '–°—É–¥–∞–∫', color: 'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100', icon: 'fa-bolt' },
            { id: '–û–∫—É–Ω—å', color: 'bg-orange-50 text-orange-700 border-orange-200 hover:bg-orange-100', icon: 'fa-layer-group' },
            { id: '–ö–æ—Ä–æ–ø', color: 'bg-yellow-50 text-yellow-700 border-yellow-200 hover:bg-yellow-100', icon: 'fa-fish' },
            { id: '–°–æ–º', color: 'bg-purple-50 text-purple-700 border-purple-200 hover:bg-purple-100', icon: 'fa-frog' },
            { id: '–Ü–Ω—à–µ', color: 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100', icon: 'fa-question' }
        ];

        // --- Auth Flow ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                // Wait for explicit user action for anon, or check if already signed in
                // Standard firebase persistence handles reload re-auth
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUI(user);
            
            if (user) {
                // Only subscribe if not already subscribed
                if (!postsUnsub) subscribeToPosts();
            } else {
                // Unsubscribe if logged out
                if (postsUnsub) {
                    postsUnsub();
                    postsUnsub = null;
                }
                // Reset feed UI for guest state
                const container = document.getElementById('posts-feed');
                container.innerHTML = `
                <div class="animate-pulse space-y-6" id="skeleton-loader">
                    <div class="bg-white rounded-3xl p-4 h-64 shadow-sm"></div>
                    <div class="bg-white rounded-3xl p-4 h-64 shadow-sm"></div>
                </div>
                `;
            }
        });

        function updateUI(user) {
            const authSection = document.getElementById('auth-section');
            const welcomeCard = document.getElementById('welcome-card');
            
            if (user) {
                // Safe check for email and name
                const emailName = user.email ? user.email.split('@')[0] : '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
                const name = user.displayName || (user.isAnonymous ? '–ì—ñ—Å—Ç—å' : emailName);
                const avatar = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}&backgroundColor=b6e3f4`;
                
                authSection.innerHTML = `
                    <div class="flex items-center gap-3 bg-white/50 backdrop-blur-sm pl-4 pr-1 py-1 rounded-full border border-white/50 shadow-sm cursor-pointer hover:bg-white/80 transition" onclick="openProfile()">
                        <div class="text-right hidden sm:block">
                            <p class="text-xs font-bold text-slate-700 leading-tight">${name}</p>
                            <p class="text-[10px] text-brand-600 font-medium">–û–Ω–ª–∞–π–Ω</p>
                        </div>
                        <img src="${avatar}" class="w-8 h-8 rounded-full bg-white object-cover border border-white shadow-sm">
                    </div>
                `;
                welcomeCard.classList.add('hidden');
                closeAuthModal();
            } else {
                authSection.innerHTML = `
                    <button onclick="openAuthModal()" class="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-900/20">–í—Ö—ñ–¥</button>
                `;
                welcomeCard.classList.remove('hidden');
            }
        }

        window.openProfile = () => {
            if(!currentUser) return openAuthModal();
            if(confirm('–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É?')) {
                signOut(auth).then(() => {
                    showToast('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏');
                    // Page reload happens automatically or state clears via onAuthStateChanged
                });
            }
        };

        window.toggleAuthMode = (mode) => {
            isRegister = mode === 'register';
            document.getElementById('tab-login').className = isRegister ? "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all" : "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition-all text-slate-800";
            document.getElementById('tab-register').className = isRegister ? "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition-all text-slate-800" : "flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all";
            document.getElementById('auth-action-btn').innerText = isRegister ? "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è" : "–£–≤—ñ–π—Ç–∏";
        };

        window.performAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('auth-action-btn');
            const errEl = document.getElementById('auth-error');
            
            if(!email || !pass) { errEl.innerText = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è"; errEl.classList.remove('hidden'); return; }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            errEl.classList.add('hidden');

            try {
                if(isRegister) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
                showToast(isRegister ? '–í—ñ—Ç–∞—î–º–æ —É –∫–ª—É–±—ñ!' : '–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º!', 'success');
            } catch(e) {
                console.error(e);
                errEl.innerText = "–ü–æ–º–∏–ª–∫–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ.";
                if(e.code?.includes('email-already-in-use')) errEl.innerText = "–ü–æ—à—Ç–∞ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è";
                if(e.code?.includes('invalid-credential')) errEl.innerText = "–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å";
                errEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = isRegister ? "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è" : "–£–≤—ñ–π—Ç–∏";
            }
        };

        window.handleGuest = async () => {
            try { await signInAnonymously(auth); showToast('–í—Ö—ñ–¥ —è–∫ –ì—ñ—Å—Ç—å'); } catch(e) { console.error(e); }
        };

        window.handleGoogleAuth = async () => {
             try { await signInWithPopup(auth, new GoogleAuthProvider()); showToast('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ Google', 'success'); }
             catch (e) { showToast('–ü–æ–º–∏–ª–∫–∞ Google Auth', 'error'); }
        };

        // --- Posts Logic ---
        
        // Setup Filters UI
        const filterContainer = document.getElementById('filters-container');
        const modalTags = document.getElementById('modal-tags');
        
        TAGS.forEach((tag, idx) => {
            // Header Filters
            if(tag.id !== '–Ü–Ω—à–µ') {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all ${idx === 0 ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`;
                btn.innerText = tag.id;
                btn.onclick = () => setFilter(tag.id, btn);
                filterContainer.appendChild(btn);
            }

            // Modal Tags
            if(tag.id !== '–í—Å—ñ') {
                const mBtn = document.createElement('button');
                mBtn.className = `px-3 py-2 rounded-xl text-xs font-bold border ${tag.color.replace('bg-', 'bg-white ')} transition-all flex items-center gap-2 group`;
                mBtn.innerHTML = `<i class="fas ${tag.icon} opacity-50 group-hover:opacity-100"></i> ${tag.id}`;
                mBtn.onclick = () => selectModalTag(tag.id, mBtn, tag.color);
                modalTags.appendChild(mBtn);
            }
        });

        function selectModalTag(tagName, btn, colorClass) {
            // Reset all
            Array.from(modalTags.children).forEach(c => {
                c.className = c.className.replace('ring-2 ring-offset-1 ring-brand-500', '').replace(/bg-[\w]+-50/, 'bg-white');
                c.classList.add('bg-white');
            });
            // Active
            btn.classList.remove('bg-white');
            btn.className += ` ring-2 ring-offset-1 ring-brand-500 ${colorClass.split(' ')[0]}`;
            document.getElementById('selected-tag').value = tagName;
        }

        function setFilter(tag, btnElement) {
            currentFilter = tag;
            // Update UI
            Array.from(filterContainer.children).forEach(c => {
                if(c.tagName === 'BUTTON') c.className = 'flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border bg-white text-slate-600 border-slate-200 hover:bg-slate-50 transition-all';
            });
            if(btnElement) btnElement.className = 'flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border bg-slate-800 text-white border-slate-800 transition-all';
            
            renderPosts();
        }

        // Realtime Listener Logic wrapped in function
        function subscribeToPosts() {
            const q = query(postsCol);
            postsUnsub = onSnapshot(q, (snapshot) => {
                postsCache = [];
                snapshot.forEach(doc => postsCache.push({ id: doc.id, ...doc.data() }));
                postsCache.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderPosts();
            }, (err) => console.error("Snapshot error:", err));
        }

        function renderPosts() {
            const container = document.getElementById('posts-feed');
            const filtered = currentFilter === '–í—Å—ñ' ? postsCache : postsCache.filter(p => p.tag === currentFilter);
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 opacity-60">
                        <div class="bg-slate-100 p-6 rounded-full mb-4">
                            <i class="fas fa-fish fa-3x text-slate-300"></i>
                        </div>
                        <p class="text-slate-500 font-medium text-sm">–ü–æ–∫–∏ —â–æ —Ç—É—Ç —Ç–∏—Ö–æ...</p>
                        ${currentFilter !== '–í—Å—ñ' ? '<button onclick="setFilter(\'–í—Å—ñ\')" class="text-brand-600 text-sm font-bold mt-2">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å–µ</button>' : ''}
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(post => {
                const isLiked = false; // Simplified for this demo
                const timeAgo = getTimeAgo(post.createdAt?.seconds);
                const tagObj = TAGS.find(t => t.id === post.tag) || TAGS[TAGS.length-1];

                return `
                <article class="glass-card rounded-3xl overflow-hidden animate-fade-in-up mb-6">
                    <!-- Post Header -->
                    <div class="p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="${post.userPhoto || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+post.userId}" class="w-10 h-10 rounded-full bg-slate-50 object-cover border border-slate-100">
                            <div>
                                <h3 class="font-bold text-sm text-slate-800 leading-tight">${post.userName}</h3>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-[10px] text-slate-400 font-medium">${timeAgo}</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-md font-bold ${tagObj.color}">${post.tag}</span>
                                </div>
                            </div>
                        </div>
                        ${currentUser && currentUser.uid === post.userId ? `<button onclick="deletePost('${post.id}')" class="text-slate-300 hover:text-red-500 px-2 transition"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </div>

                    <!-- Content Text -->
                    <div class="px-4 pb-2">
                        <p class="text-slate-700 text-[15px] leading-relaxed whitespace-pre-wrap">${escapeHtml(post.content)}</p>
                    </div>

                    <!-- Image -->
                    ${post.imageUrl ? `
                    <div class="mt-2 relative group cursor-pointer overflow-hidden bg-slate-100" onclick="openLightbox('${escapeHtml(post.imageUrl)}')">
                        <img src="${escapeHtml(post.imageUrl)}" class="w-full h-auto max-h-[500px] object-cover transition duration-700 group-hover:scale-105" loading="lazy" onerror="this.parentElement.style.display='none'">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition duration-300 flex items-center justify-center">
                            <i class="fas fa-expand-alt text-white opacity-0 group-hover:opacity-100 drop-shadow-lg transform scale-50 group-hover:scale-100 transition duration-300"></i>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Actions -->
                    <div class="px-4 py-3 flex items-center gap-4">
                        <button onclick="likePost('${post.id}')" class="flex items-center gap-2 group">
                            <div class="w-9 h-9 rounded-full bg-slate-50 group-hover:bg-red-50 flex items-center justify-center transition text-slate-400 group-hover:text-red-500">
                                <i class="${post.likes > 0 ? 'fas text-red-500' : 'far'} fa-heart transition-transform group-active:scale-125"></i>
                            </div>
                            <span class="text-sm font-bold text-slate-600 group-hover:text-red-500 transition">${post.likes || 0}</span>
                        </button>

                        <button onclick="toggleComments('${post.id}')" class="flex items-center gap-2 group">
                            <div class="w-9 h-9 rounded-full bg-slate-50 group-hover:bg-blue-50 flex items-center justify-center transition text-slate-400 group-hover:text-blue-500">
                                <i class="far fa-comment-dots"></i>
                            </div>
                            <span class="text-sm font-bold text-slate-600 group-hover:text-blue-500 transition">–ö–æ–º–µ–Ω—Ç.</span>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div id="comments-${post.id}" class="hidden bg-slate-50/50 border-t border-slate-100 p-4">
                        <div id="comments-list-${post.id}" class="space-y-3 mb-4 max-h-60 overflow-y-auto hide-scrollbar"></div>
                        <form onsubmit="submitComment(event, '${post.id}')" class="relative flex items-center gap-2">
                             <img src="${currentUser?.photoURL || 'https://api.dicebear.com/7.x/avataaars/svg?seed=guest'}" class="w-8 h-8 rounded-full border border-white shadow-sm">
                             <div class="relative flex-1">
                                <input type="text" name="text" placeholder="–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä..." class="w-full bg-white border-none rounded-2xl py-2 pl-4 pr-10 text-sm shadow-sm focus:ring-2 focus:ring-brand-500/50 transition">
                                <button type="submit" class="absolute right-2 top-1.5 text-brand-600 hover:text-brand-700 w-7 h-7 flex items-center justify-center rounded-full hover:bg-brand-50 transition">
                                    <i class="fas fa-paper-plane text-xs"></i>
                                </button>
                             </div>
                        </form>
                    </div>
                </article>
                `;
            }).join('');
        }

        // --- Actions ---
        window.likePost = async (id) => {
            if(!currentUser) { showToast('–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ª–∞–π–∫–∞—Ç–∏', 'error'); return openAuthModal(); }
            // Optimistic update visual (optional, simplified here rely on firestore)
            const ref = doc(postsCol, id);
            await updateDoc(ref, { likes: increment(1) });
        };

        window.deletePost = async (id) => {
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø–æ—Å—Ç?')) return;
            try { await deleteDoc(doc(postsCol, id)); showToast('–í–∏–¥–∞–ª–µ–Ω–æ'); } catch(e) { console.error(e); }
        };

        window.submitPost = async () => {
            const text = document.getElementById('post-text').value;
            const img = document.getElementById('post-image-url').value;
            const tag = document.getElementById('selected-tag').value;
            const btn = document.getElementById('btn-publish');

            if(!text) return showToast('–ù–∞–ø–∏—à—ñ—Ç—å —â–æ—Å—å...', 'error');
            if(!currentUser) return openAuthModal();

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await addDoc(postsCol, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || (currentUser.isAnonymous ? '–ì—ñ—Å—Ç—å' : currentUser.email.split('@')[0]),
                    userPhoto: currentUser.photoURL,
                    content: text,
                    imageUrl: img,
                    tag: tag,
                    likes: 0,
                    createdAt: serverTimestamp()
                });
                showToast('–ó–≤—ñ—Ç –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ! üèÜ', 'success');
                closeModal();
                document.getElementById('post-text').value = '';
                clearImage();
            } catch (e) {
                console.error(e);
                showToast('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</span><i class="fas fa-paper-plane text-xs opacity-70"></i>';
            }
        };

        // --- Comments ---
        let commentsUnsub = {};
        window.toggleComments = (id) => {
            const el = document.getElementById(`comments-${id}`);
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                loadComments(id);
            } else {
                el.classList.add('hidden');
                if(commentsUnsub[id]) { commentsUnsub[id](); delete commentsUnsub[id]; }
            }
        };

        function loadComments(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            const qC = query(commentsCol, where("postId", "==", postId), orderBy('createdAt', 'asc')); // Client sort backup
            
            // Note: Compound query might need index. If failed, remove orderBy and sort in JS
            commentsUnsub[postId] = onSnapshot(qC, (snap) => {
                const comms = [];
                snap.forEach(d => comms.push(d.data()));
                comms.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));

                if(comms.length === 0) { list.innerHTML = '<p class="text-xs text-slate-400 text-center italic">–¢–∏—à–∞... –ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º!</p>'; return; }

                list.innerHTML = comms.map(c => `
                    <div class="flex gap-2 text-sm animate-fade-in-up">
                         <img src="${c.userPhoto || 'https://api.dicebear.com/7.x/avataaars/svg?seed=guest'}" class="w-6 h-6 rounded-full bg-white flex-shrink-0">
                         <div class="bg-white px-3 py-2 rounded-2xl rounded-tl-none shadow-sm border border-slate-50">
                            <span class="font-bold text-xs text-slate-600 block mb-0.5">${escapeHtml(c.userName)}</span>
                            <span class="text-slate-800 leading-snug">${escapeHtml(c.text)}</span>
                         </div>
                    </div>
                `).join('');
                list.scrollTop = list.scrollHeight;
            }, (e) => {
                console.log("Comment error (needs index likely):", e);
                // Fallback for no-index env
                 onSnapshot(query(commentsCol, where("postId", "==", postId)), (sn) => {
                     const c = []; sn.forEach(d=>c.push(d.data()));
                     c.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
                     // Render logic same as above (simplified for brevity)
                 });
            });
        }

        window.submitComment = async (e, postId) => {
            e.preventDefault();
            if(!currentUser) return openAuthModal();
            const inp = e.target.text;
            const val = inp.value.trim();
            if(!val) return;
            
            inp.value = '';
            try {
                await addDoc(commentsCol, {
                    postId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || (currentUser.isAnonymous ? '–ì—ñ—Å—Ç—å' : currentUser.email.split('@')[0]),
                    userPhoto: currentUser.photoURL,
                    text: val,
                    createdAt: serverTimestamp()
                });
            } catch(err) { showToast('–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏', 'error'); inp.value = val; }
        };


        // --- UI Utils ---
        window.openModal = () => {
            if(!currentUser) return openAuthModal();
            const m = document.getElementById('modal');
            const c = document.getElementById('modal-content');
            const b = document.getElementById('modal-backdrop');
            m.classList.remove('hidden');
            // Force reflow
            void m.offsetWidth;
            b.classList.remove('opacity-0');
            c.classList.remove('translate-y-full', 'opacity-0');
            c.classList.add('translate-y-0', 'opacity-100');
        };

        window.closeModal = () => {
            const m = document.getElementById('modal');
            const c = document.getElementById('modal-content');
            const b = document.getElementById('modal-backdrop');
            
            c.classList.remove('translate-y-0');
            c.classList.add('translate-y-full');
            b.classList.add('opacity-0');
            setTimeout(() => m.classList.add('hidden'), 300);
        };

        window.openAuthModal = () => {
             const m = document.getElementById('auth-modal');
             const box = document.getElementById('auth-box');
             m.classList.remove('hidden', 'flex'); m.classList.add('flex');
             void m.offsetWidth;
             box.classList.remove('scale-95', 'opacity-0');
             box.classList.add('scale-100', 'opacity-100');
        };

        window.closeAuthModal = () => {
             const m = document.getElementById('auth-modal');
             const box = document.getElementById('auth-box');
             box.classList.remove('scale-100', 'opacity-100');
             box.classList.add('scale-95', 'opacity-0');
             setTimeout(() => m.classList.replace('flex', 'hidden'), 300);
        };

        window.openLightbox = (src) => {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lb.classList.remove('hidden', 'flex'); lb.classList.add('flex');
            void lb.offsetWidth;
            lb.classList.remove('opacity-0');
            img.classList.remove('scale-95'); img.classList.add('scale-100');
        };

        window.closeLightbox = () => {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            lb.classList.add('opacity-0');
            img.classList.remove('scale-100'); img.classList.add('scale-95');
            setTimeout(() => lb.classList.replace('flex', 'hidden'), 300);
        };

        window.previewImage = (url) => {
            const box = document.getElementById('image-preview-box');
            if(url.length > 5) {
                box.classList.remove('hidden');
                document.getElementById('img-preview-el').src = url;
            } else {
                box.classList.add('hidden');
            }
        };

        window.clearImage = () => {
            document.getElementById('post-image-url').value = '';
            document.getElementById('image-preview-box').classList.add('hidden');
        };

        window.pasteFromClipboard = async () => {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('post-image-url').value = text;
                previewImage(text);
            } catch(e) { showToast('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—Å—Ç–∞–≤–∏—Ç–∏', 'error'); }
        };

        window.showToast = (msg, type='info') => {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            const bg = type==='success' ? 'bg-emerald-600' : (type==='error'?'bg-red-500':'bg-slate-800');
            const icon = type==='success' ? 'check-circle' : (type==='error'?'exclamation-circle':'info-circle');
            
            t.className = `${bg} text-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3 text-sm font-medium toast-enter transition-all transform duration-300 backdrop-blur-md bg-opacity-95`;
            t.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
            
            c.appendChild(t);
            requestAnimationFrame(() => {
                 t.classList.remove('toast-enter');
                 t.classList.add('toast-enter-active');
            });

            setTimeout(() => {
                t.classList.remove('toast-enter-active');
                t.classList.add('toast-exit-active');
                setTimeout(() => t.remove(), 300);
            }, 3000);
        };

        function getTimeAgo(seconds) {
            if(!seconds) return '';
            const diff = Math.floor(Date.now()/1000) - seconds;
            if(diff < 60) return '—Ç—ñ–ª—å–∫–∏ —â–æ';
            if(diff < 3600) return `${Math.floor(diff/60)} —Ö–≤`;
            if(diff < 86400) return `${Math.floor(diff/3600)} –≥–æ–¥`;
            return `${Math.floor(diff/86400)} –¥–Ω`;
        }
        
        function escapeHtml(text) {
             if(!text) return '';
             return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
