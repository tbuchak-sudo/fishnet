<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FishNet - –°–æ—Ü–º–µ—Ä–µ–∂–∞</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4267b2">
    <link rel="apple-touch-icon" href="icon.png"> 

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #e9ebee; padding-bottom: 80px; }
        
        header { 
            background: #4267b2; color: #fff; padding: 15px; 
            border-radius: 8px 8px 0 0; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .logo { font-weight: bold; font-size: 24px; }
        
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        #loginBtn { background: white; color: #4267b2; padding: 8px 15px; }
        #logoutBtn { background: #3b5998; color: white; border: 1px solid white; padding: 5px 10px; display: none; }
        
        #post-form { background: #fff; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; margin-bottom: 20px;}
        textarea { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; resize: vertical; margin-bottom: 10px; min-height: 60px;}
        
        .form-tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .file-label { cursor: pointer; color: #4267b2; font-size: 24px; padding: 5px; display: flex; align-items: center; gap: 5px; }
        .file-label span { font-size: 14px; font-weight: normal; }
        #imageInput { display: none; } 

        #preview-container { display: none; margin-bottom: 10px; position: relative; width: fit-content; }
        #preview-img { max-height: 150px; border-radius: 8px; border: 1px solid #ddd; }
        #remove-img { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 22px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        #sendBtn { background: #42b72a; color: white; padding: 10px 20px; font-size: 16px; }
        
        #guest-msg { text-align: center; padding: 20px; background: white; margin-top: 10px; border-radius: 8px; }

        .post { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .author-name { color: #4267b2; font-weight: bold; font-size: 16px; }
        .post-date { color: #90949c; font-size: 12px; }
        .post-text { color: #1c1e21; line-height: 1.5; white-space: pre-wrap; margin-bottom: 10px; }
        .post-image { width: 100%; max-height: 500px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; cursor: pointer;}

        .actions { border-top: 1px solid #eee; padding-top: 10px; display: flex; align-items: center; gap: 15px; }
        .like-btn { background: none; color: #606770; padding: 5px 10px; display: flex; align-items: center; gap: 5px; font-size: 14px; }
        .like-active { color: #e0245e; }

        .comments-section { margin-top: 10px; background: #f0f2f5; padding: 10px; border-radius: 8px; }
        .comment { margin-bottom: 8px; font-size: 13px; }
        .comment-input-area { display: flex; gap: 5px; margin-top: 10px; }
        .comment-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; }
        .comment-btn { background: #4267b2; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; }

        .delete-btn { position: absolute; top: 15px; right: 15px; background: none; color: #ccc; font-size: 16px; }
        .delete-btn:hover { color: #ff4d4d; }

        /* –ö–Ω–æ–ø–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è (PWA) */
        #installBtn { 
            display: none; width: 100%; background: #333; color: white; padding: 15px; 
            text-align: center; position: fixed; bottom: 0; left: 0; z-index: 1000; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">FishNet üêü</div>
        <div>
            <span id="user-display" style="font-size: 14px; margin-right: 10px;"></span>
            <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
            <button id="logoutBtn">–í–∏–π—Ç–∏</button>
        </div>
    </header>

    <div id="installBtn">üì≤ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫ FishNet</div>

    <div id="post-form">
        <textarea id="message" rows="3" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
        <div id="preview-container">
            <img id="preview-img" src="">
            <div id="remove-img" onclick="clearImage()">√ó</div>
        </div>
        <div class="form-tools">
            <label class="file-label">
                üìé <span>–§–æ—Ç–æ</span>
                <input type="file" id="imageInput" accept="image/*">
            </label>
            <button id="sendBtn">–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è</button>
        </div>
    </div>

    <div id="guest-msg">–©–æ–± –¥—ñ–ª–∏—Ç–∏—Å—è —Ñ–æ—Ç–æ, —É–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google.</div>

    <div id="feed">
        <p style="text-align:center; color:#777;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCN7xN8AZXXCxwf9GmuILYi5AcKAUYJVB4",
            authDomain: "fishnet-cb1ad.firebaseapp.com",
            projectId: "fishnet-cb1ad",
            messagingSenderId: "672721719482",
            appId: "1:672721719482:web:9b0ce0e3e41893fcccb283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const postForm = document.getElementById('post-form');
        const guestMsg = document.getElementById('guest-msg');
        const userDisplay = document.getElementById('user-display');
        const feed = document.getElementById('feed');
        const sendBtn = document.getElementById('sendBtn');
        const imageInput = document.getElementById('imageInput');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');

        // --- PWA –õ–û–ì–Ü–ö–ê ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
            });
        });
        // ------------------

        let currentUser = null;
        let selectedFile = null;

        loginBtn.onclick = () => signInWithPopup(auth, provider);
        logoutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                postForm.style.display = 'block';
                guestMsg.style.display = 'none';
                userDisplay.textContent = user.displayName.split(' ')[0];
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                postForm.style.display = 'none';
                guestMsg.style.display = 'block';
                userDisplay.textContent = '';
            }
            renderFeed();
        });

        imageInput.onchange = (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(selectedFile);
            }
        };

        window.clearImage = () => {
            selectedFile = null;
            imageInput.value = '';
            previewContainer.style.display = 'none';
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scale = MAX_WIDTH / img.width;
                        if (scale < 1) {
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scale;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        }

        sendBtn.onclick = async () => {
            const msg = document.getElementById('message').value;
            if((msg.trim() || selectedFile) && currentUser) {
                sendBtn.disabled = true;
                sendBtn.innerText = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
                try {
                    let imageUrl = null;
                    if (selectedFile) {
                        imageUrl = await compressImage(selectedFile);
                    }
                    await addDoc(collection(db, "posts"), {
                        text: msg,
                        imageUrl: imageUrl, 
                        timestamp: serverTimestamp(),
                        uid: currentUser.uid,
                        author: currentUser.displayName,
                        photo: currentUser.photoURL,
                        likes: [],
                        comments: []
                    });
                    document.getElementById('message').value = '';
                    clearImage();
                } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞: " + e.message); }
                sendBtn.disabled = false;
                sendBtn.innerText = "–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è";
            }
        };

        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        let postsData = [];

        onSnapshot(q, (snapshot) => {
            postsData = [];
            snapshot.forEach(doc => postsData.push({ id: doc.id, ...doc.data() }));
            renderFeed();
        });

        function renderFeed() {
            feed.innerHTML = '';
            if (postsData.length === 0) {
                feed.innerHTML = '<p style="text-align:center; color:#777;">–ü—É—Å—Ç–æ...</p>';
                return;
            }

            postsData.forEach(post => {
                let timeString = "...";
                if(post.timestamp) {
                    const date = post.timestamp.toDate();
                    timeString = date.toLocaleTimeString().slice(0,5) + ' ' + date.toLocaleDateString();
                }
                const avatarUrl = post.photo || 'https://ui-avatars.com/api/?name=' + post.author;
                const likes = post.likes || [];
                const isLiked = currentUser && likes.includes(currentUser.uid);
                
                const postEl = document.createElement('div');
                postEl.className = 'post';
                
                let html = `
                    <div class="post-header">
                        <img src="${avatarUrl}" class="avatar">
                        <div>
                            <div class="author-name">${post.author}</div>
                            <div class="post-date">${timeString}</div>
                        </div>
                    </div>
                    <div class="post-text">${post.text}</div>
                    ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image">` : ''}
                    
                    <div class="actions">
                        <button class="like-btn ${isLiked ? 'like-active' : ''}" onclick="toggleLike('${post.id}', ${isLiked})">
                            ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span>${likes.length || '–õ–∞–π–∫'}</span>
                        </button>
                    </div>

                    <div class="comments-section">
                        <div id="comments-${post.id}"></div> 
                        ${currentUser ? `
                        <div class="comment-input-area">
                            <input type="text" id="input-${post.id}" class="comment-input" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä...">
                            <button onclick="addComment('${post.id}')" class="comment-btn">‚û§</button>
                        </div>
                        ` : ''}
                    </div>
                `;

                if (currentUser && post.uid === currentUser.uid) {
                    html += `<button class="delete-btn" onclick="deletePost('${post.id}')">üóëÔ∏è</button>`;
                }
                postEl.innerHTML = html;

                const commentsContainer = postEl.querySelector(`#comments-${post.id}`);
                (post.comments || []).forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'comment';
                    div.innerHTML = `<strong>${c.author}:</strong> ${c.text}`;
                    commentsContainer.appendChild(div);
                });
                feed.appendChild(postEl);
            });
        }

        window.deletePost = (id) => { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) deleteDoc(doc(db, "posts", id)); };
        window.toggleLike = async (id, isLiked) => {
            if (!currentUser) return;
            const postRef = doc(db, "posts", id);
            await updateDoc(postRef, { likes: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
        };
        window.addComment = async (id) => {
            const input = document.getElementById(`input-${id}`);
            const text = input.value.trim();
            if (!text) return;
            const postRef = doc(db, "posts", id);
            await updateDoc(postRef, {
                comments: arrayUnion({ author: currentUser.displayName.split(' ')[0], text: text, uid: currentUser.uid, time: Date.now() })
            });
        };
    </script>
</body>
</html>
