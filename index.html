<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FishNet - –°–æ—Ü–º–µ—Ä–µ–∂–∞</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #e9ebee; }
        
        /* –®–∞–ø–∫–∞ */
        header { 
            background: #4267b2; color: #fff; padding: 15px; 
            border-radius: 8px 8px 0 0; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: bold; font-size: 24px; }
        
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        #loginBtn { background: white; color: #4267b2; padding: 8px 15px; }
        #logoutBtn { background: #3b5998; color: white; border: 1px solid white; padding: 5px 10px; display: none; }
        
        /* –§–æ—Ä–º–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó */
        #post-form { background: #fff; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }
        textarea { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; resize: vertical; margin-bottom: 10px;}
        #sendBtn { background: #42b72a; color: white; padding: 12px; width: 100%; font-size: 16px; }
        #sendBtn:hover { background: #36a420; }
        
        #guest-msg { text-align: center; padding: 20px; background: white; margin-top: 10px; border-radius: 8px; }

        /* –ü–æ—Å—Ç–∏ */
        #feed { margin-top: 20px; }
        .post { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .author-name { color: #4267b2; font-weight: bold; font-size: 16px; }
        .post-date { color: #90949c; font-size: 12px; }
        .post-text { color: #1c1e21; line-height: 1.5; white-space: pre-wrap; margin-bottom: 15px; }

        /* –ü–∞–Ω–µ–ª—å –¥—ñ–π (–õ–∞–π–∫–∏) */
        .actions { border-top: 1px solid #eee; padding-top: 10px; display: flex; align-items: center; gap: 15px; }
        .like-btn { background: none; color: #606770; padding: 5px 10px; display: flex; align-items: center; gap: 5px; font-size: 14px; transition: 0.2s; }
        .like-btn:hover { background-color: #f0f2f5; border-radius: 4px; }
        .like-active { color: #e0245e; } /* –ß–µ—Ä–≤–æ–Ω–∏–π –∫–æ–ª—ñ—Ä –¥–ª—è –ª–∞–π–∫–∞ */

        /* –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ */
        .comments-section { margin-top: 10px; background: #f0f2f5; padding: 10px; border-radius: 8px; }
        .comment { margin-bottom: 8px; font-size: 13px; }
        .comment strong { color: #365899; }
        .comment-input-area { display: flex; gap: 5px; margin-top: 10px; }
        .comment-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; }
        .comment-btn { background: #4267b2; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; }

        .delete-btn { position: absolute; top: 15px; right: 15px; background: none; color: #ccc; font-size: 16px; }
        .delete-btn:hover { color: #ff4d4d; }
    </style>
</head>
<body>

    <header>
        <div class="logo">FishNet üêü</div>
        <div>
            <span id="user-display" style="font-size: 14px; margin-right: 10px;"></span>
            <button id="loginBtn">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
            <button id="logoutBtn">–í–∏–π—Ç–∏</button>
        </div>
    </header>

    <div id="post-form">
        <textarea id="message" rows="3" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
        <button id="sendBtn">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div id="guest-msg">–©–æ–± –ø–∏—Å–∞—Ç–∏ —Ç–∞ –ª–∞–π–∫–∞—Ç–∏, —É–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google.</div>

    <div id="feed">
        <p style="text-align:center; color:#777;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // –î–æ–¥–∞–ª–∏ updateDoc, arrayUnion, arrayRemove –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–∞–π–∫—ñ–≤ —ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCN7xN8AZXXCxwf9GmuILYi5AcKAUYJVB4",
            authDomain: "fishnet-cb1ad.firebaseapp.com",
            projectId: "fishnet-cb1ad",
            storageBucket: "fishnet-cb1ad.firebasestorage.app",
            messagingSenderId: "672721719482",
            appId: "1:672721719482:web:9b0ce0e3e41893fcccb283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const postForm = document.getElementById('post-form');
        const guestMsg = document.getElementById('guest-msg');
        const userDisplay = document.getElementById('user-display');
        const feed = document.getElementById('feed');
        const sendBtn = document.getElementById('sendBtn');

        let currentUser = null;

        // –í—Ö—ñ–¥/–í–∏—Ö—ñ–¥
        loginBtn.onclick = () => signInWithPopup(auth, provider);
        logoutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                postForm.style.display = 'block';
                guestMsg.style.display = 'none';
                userDisplay.textContent = user.displayName.split(' ')[0];
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                postForm.style.display = 'none';
                guestMsg.style.display = 'block';
                userDisplay.textContent = '';
            }
            renderFeed(); // –û–Ω–æ–≤–ª—é—î–º–æ, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –ª–∞–π–∫–∏
        });

        // –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
        sendBtn.onclick = async () => {
            const msg = document.getElementById('message').value;
            if(msg.trim() && currentUser) {
                sendBtn.disabled = true;
                try {
                    await addDoc(collection(db, "posts"), {
                        text: msg,
                        timestamp: serverTimestamp(),
                        uid: currentUser.uid,
                        author: currentUser.displayName,
                        photo: currentUser.photoURL,
                        likes: [],    // –ü–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫ –ª–∞–π–∫—ñ–≤
                        comments: []  // –ü–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
                    });
                    document.getElementById('message').value = '';
                } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞: " + e.message); }
                sendBtn.disabled = false;
            }
        };

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—Ä—ñ—á–∫–∏
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        let postsData = [];

        onSnapshot(q, (snapshot) => {
            postsData = [];
            snapshot.forEach(doc => postsData.push({ id: doc.id, ...doc.data() }));
            renderFeed();
        });

        function renderFeed() {
            feed.innerHTML = '';
            if (postsData.length === 0) {
                feed.innerHTML = '<p style="text-align:center; color:#777;">–ü—É—Å—Ç–æ...</p>';
                return;
            }

            postsData.forEach(post => {
                // –ß–∞—Å
                let timeString = "...";
                if(post.timestamp) {
                    const date = post.timestamp.toDate();
                    timeString = date.toLocaleTimeString().slice(0,5) + ' ' + date.toLocaleDateString();
                }
                const avatarUrl = post.photo || 'https://ui-avatars.com/api/?name=' + post.author;

                // –õ–û–ì–Ü–ö–ê –õ–ê–ô–ö–Ü–í
                const likes = post.likes || [];
                const isLiked = currentUser && likes.includes(currentUser.uid);
                const likeCount = likes.length;
                const likeClass = isLiked ? 'like-active' : '';
                const likeIcon = isLiked ? '‚ù§Ô∏è' : 'ü§ç';

                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è HTML
                const postEl = document.createElement('div');
                postEl.className = 'post';
                
                let html = `
                    <div class="post-header">
                        <img src="${avatarUrl}" class="avatar">
                        <div>
                            <div class="author-name">${post.author}</div>
                            <div class="post-date">${timeString}</div>
                        </div>
                    </div>
                    <div class="post-text">${post.text}</div>
                    
                    <div class="actions">
                        <button class="like-btn ${likeClass}" onclick="toggleLike('${post.id}', ${isLiked})">
                            ${likeIcon} <span>${likeCount || '–õ–∞–π–∫'}</span>
                        </button>
                    </div>

                    <div class="comments-section">
                        <div id="comments-${post.id}"></div> 
                        ${currentUser ? `
                        <div class="comment-input-area">
                            <input type="text" id="input-${post.id}" class="comment-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä...">
                            <button onclick="addComment('${post.id}')" class="comment-btn">‚û§</button>
                        </div>
                        ` : ''}
                    </div>
                `;

                if (currentUser && post.uid === currentUser.uid) {
                    html += `<button class="delete-btn" onclick="deletePost('${post.id}')">üóëÔ∏è</button>`;
                }

                postEl.innerHTML = html;

                // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
                const commentsContainer = postEl.querySelector(`#comments-${post.id}`);
                const comments = post.comments || [];
                comments.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'comment';
                    div.innerHTML = `<strong>${c.author}:</strong> ${c.text}`;
                    commentsContainer.appendChild(div);
                });

                feed.appendChild(postEl);
            });
        }

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (—â–æ–± –ø—Ä–∞—Ü—é–≤–∞–ª–∏ –≤ onclick) ---
        
        window.deletePost = (id) => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) deleteDoc(doc(db, "posts", id));
        };

        window.toggleLike = async (id, isLiked) => {
            if (!currentUser) { alert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ª–∞–π–∫–∞—Ç–∏!"); return; }
            const postRef = doc(db, "posts", id);
            
            if (isLiked) {
                // –ó–∞–±–∏—Ä–∞—î–º–æ –ª–∞–π–∫ (–≤–∏–¥–∞–ª—è—î–º–æ —Å–≤—ñ–π ID –∑—ñ —Å–ø–∏—Å–∫—É)
                await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
            } else {
                // –°—Ç–∞–≤–∏–º–æ –ª–∞–π–∫ (–¥–æ–¥–∞—î–º–æ —Å–≤—ñ–π ID —É —Å–ø–∏—Å–æ–∫)
                await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
            }
        };

        window.addComment = async (id) => {
            const input = document.getElementById(`input-${id}`);
            const text = input.value.trim();
            if (!text) return;

            const postRef = doc(db, "posts", id);
            await updateDoc(postRef, {
                comments: arrayUnion({
                    author: currentUser.displayName.split(' ')[0], // –¢—ñ–ª—å–∫–∏ —ñ–º'—è
                    text: text,
                    uid: currentUser.uid,
                    time: Date.now()
                })
            });
        };
    </script>
</body>
</html>
