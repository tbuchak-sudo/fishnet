<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FishNet</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00c6ff">
    <link rel="apple-touch-icon" href="icon.png"> 

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-body: #f0f2f5; --bg-card: rgba(255, 255, 255, 0.95);
            --text-main: #1c1e21; --text-sec: #65676b; --input-bg: #f0f2f5; --border: #e4e6eb;
            --gradient-header: linear-gradient(135deg, #00c6ff, #0072ff); 
            --gradient-btn: linear-gradient(45deg, #00c6ff, #0072ff);
            --gradient-cover: linear-gradient(to right bottom, #00c6ff, #0072ff, #3a7bd5);
            --accent: #0072ff; --fab-color: white; --shadow: rgba(0,0,0,0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
        }
        body.dark-mode {
            --bg-body: #121212; --bg-card: rgba(30, 30, 30, 0.95);
            --text-main: #e4e6eb; --text-sec: #b0b3b8; --input-bg: #2a2a2a; --border: #3e4042;
            --gradient-header: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --gradient-btn: linear-gradient(45deg, #1CB5E0, #000851);
            --gradient-cover: linear-gradient(to right bottom, #0f2027, #203a43, #2c5364);
            --accent: #4599ff; --fab-color: #ffffff; --shadow: rgba(0,0,0,0.5);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            max-width: 600px; margin: 0 auto; background: var(--bg-body); 
            color: var(--text-main); padding-bottom: 80px; transition: 0.3s; min-height: 100vh;
        }
        
        header { 
            background: var(--gradient-header); color: #fff; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: var(--glass-border);
        }
        .logo { font-weight: 900; font-size: 24px; cursor: pointer; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .nav-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-left: 15px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));}

        .view { display: none; height: 100%; }
        .view.active { display: block; }

        /* MAP STYLES */
        #map-container { height: calc(100vh - 70px); width: 100%; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* Popup Styles in Map */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .map-popup-img { width: 100%; height: 120px; object-fit: cover; }
        .map-popup-text { padding: 10px; font-size: 13px; color: #333; }
        .map-popup-author { font-weight: bold; color: var(--accent); }

        /* ... (–°—Ç–∞—Ä—ñ —Å—Ç–∏–ª—ñ –±–µ–∑ –∑–º—ñ–Ω) ... */
        .profile-header { background: var(--bg-card); padding: 0 0 20px 0; border-radius: 0 0 16px 16px; text-align: center; margin-bottom: 20px; box-shadow: 0 2px 10px var(--shadow); border: var(--glass-border); border-top: none; }
        .cover-photo { height: 160px; background: var(--gradient-cover) !important; border-radius: 0 0 30% 30% / 20%; position: relative; overflow: hidden; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg-card); margin-top: -60px; background: white; position: relative; z-index: 10; box-shadow: 0 4px 10px var(--shadow); }
        .profile-name { font-size: 24px; font-weight: 800; margin-top: 10px; background: var(--gradient-header); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block;}
        .profile-bio { color: var(--text-sec); font-size: 15px; margin: 5px 20px 15px 20px; font-style: italic; }
        .profile-info { text-align: left; padding: 0 25px; margin-top: 25px; border-top: 1px solid var(--border); padding-top: 20px; }
        .info-row { display: flex; margin-bottom: 12px; font-size: 14px; }
        .info-label { width: 130px; color: var(--text-sec); font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .info-val { color: var(--text-main); font-weight: 500; flex: 1; }
        .profile-stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; font-size: 14px; color: var(--text-sec); }
        .stat-val { font-weight: 800; color: var(--accent); display: block; font-size: 20px; }
        .btn-primary { background: var(--gradient-btn); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 700; cursor: pointer; width: 80%; transition: 0.3s; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 114, 255, 0.4); }
        .btn-secondary { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border); padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.2s;}
        .edit-group { margin-bottom: 15px; }
        .edit-label { display: block; font-size: 12px; color: var(--text-sec); margin-bottom: 5px; font-weight: bold; }
        .edit-input, .edit-select, .edit-textarea { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); border-radius: 10px; box-sizing: border-box; font-family: inherit; transition: 0.3s; }
        .search-box { position: sticky; top: 58px; z-index: 90; background: var(--bg-body); padding: 10px 10px 0 10px; backdrop-filter: blur(10px); background: transparent;}
        .search-input { width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); outline: none; box-sizing: border-box; box-shadow: 0 2px 10px var(--shadow); backdrop-filter: blur(5px);}
        .post { background: var(--bg-card); padding: 16px; margin-bottom: 16px; border-radius: 16px; box-shadow: 0 2px 10px var(--shadow); margin-top: 10px; border: var(--glass-border); }
        .post-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; cursor: pointer; box-shadow: 0 2px 5px var(--shadow);}
        .author-name { font-weight: 700; color: var(--text-main); font-size: 15px; cursor: pointer; }
        .post-image { width: 100%; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
        .actions { border-top: 1px solid var(--border); padding-top: 12px; display: flex; gap: 20px; }
        .action-btn { background: none; border: none; color: var(--text-sec); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500;}
        .like-active { color: #e0245e; }
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--gradient-btn); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 20px rgba(0, 114, 255, 0.4); transition: 0.3s; }
        .fab.hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: flex-end; backdrop-filter: blur(3px);}
        .modal-overlay.open { display: flex; }
        #post-form { width: 100%; background: var(--bg-card); padding: 25px; border-radius: 20px 20px 0 0; max-width: 600px; margin: 0 auto; border: var(--glass-border);}
        #edit-modal-content { width: 100%; background: var(--bg-card); padding: 25px; border-radius: 20px 20px 0 0; max-width: 600px; margin: 0 auto; max-height: 90vh; overflow-y: auto; border: var(--glass-border); }
        .delete-btn { margin-left: auto; color: var(--text-sec); cursor: pointer; }
        #loginBtn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; backdrop-filter: blur(5px); transition: 0.3s;}
        .tab-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-sec); padding: 8px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: var(--gradient-btn); color: white; border-color: transparent; box-shadow: 0 2px 10px rgba(0, 114, 255, 0.3);}
        
        /* –ö–Ω–æ–ø–∫–∞ –ª–æ–∫–∞—Ü—ñ—ó */
        .location-btn { color: var(--accent); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; margin: 10px 0; padding: 10px; border: 1px solid var(--border); border-radius: 10px; width: fit-content; }
        .location-btn.active { background: #e7f3ff; border-color: var(--accent); }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="goHome()">FishNet üêü</div>
        <div style="display:flex; align-items:center;">
            <button class="nav-btn" onclick="goToMap()">üó∫Ô∏è</button> <button class="nav-btn" onclick="goToMyProfile()">üë§</button>
            <button id="themeBtn" style="background:none; border:none; font-size:22px; cursor:pointer; margin-left:10px;">üåô</button>
        </div>
    </header>

    <div id="view-home" class="view active">
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ—à—É–∫...">
        </div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
            <button class="tab-btn active" onclick="filterFeed('all')">üåê –í—Å—ñ</button>
            <button class="tab-btn" onclick="filterFeed('friends')">üë• –î—Ä—É–∑—ñ</button>
        </div>
        <div id="feed" style="padding:15px 10px;"></div>
        <div id="fab" class="fab hidden" onclick="toggleModal('post-modal', true)">+</div>
    </div>

    <div id="view-map" class="view">
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div class="profile-header">
            <div class="cover-photo"></div>
            <img id="p-avatar" src="" class="profile-avatar">
            <div id="p-name" class="profile-name">Name</div>
            <div id="p-bio" class="profile-bio">Status</div>
            <div class="profile-stats">
                <div><span class="stat-val" id="p-followers">0</span>–ü—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</div>
                <div><span class="stat-val" id="p-following">0</span>–ü—ñ–¥–ø–∏—Å–æ–∫</div>
            </div>
            <button id="p-action-btn" class="btn-primary">–î—ñ—è</button>
            <div class="profile-info">
                <div class="info-row"><div class="info-label">üìç –õ–æ–∫–∞—Ü—ñ—è</div><div class="info-val" id="p-location">-</div></div>
                <div class="info-row"><div class="info-label">üé£ –°—Ç–∏–ª—å</div><div class="info-val" id="p-style">-</div></div>
                <div class="info-row"><div class="info-label">üõ∂ –°–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è</div><div class="info-val" id="p-gear">-</div></div>
                <div class="info-row"><div class="info-label">üó∫Ô∏è –ú—ñ—Å—Ü—è</div><div class="info-val" id="p-spots">-</div></div>
            </div>
        </div>
        <div id="profile-feed" style="padding:0 10px 20px 10px;"></div>
    </div>

    <div id="post-modal" class="modal-overlay" onclick="toggleModal('post-modal', false)">
        <div id="post-form" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0">–ù–æ–≤–∏–π –ø–æ—Å—Ç</h3>
                <span onclick="toggleModal('post-modal', false)" style="cursor:pointer; font-size:24px; opacity:0.6;">√ó</span>
            </div>
            <textarea id="message" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; box-sizing:border-box; background:var(--input-bg); color:var(--text-main);" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
            
            <div id="location-btn" class="location-btn" onclick="getLocation()">
                üìç –î–æ–¥–∞—Ç–∏ –º—ñ—Å—Ü–µ (GPS)
            </div>

            <label style="cursor:pointer; display:block; margin:15px 0; color:var(--accent); font-weight:600;">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ <input type="file" id="imageInput" hidden></label>
            <button onclick="publishPost()" class="btn-primary" style="width:100%">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay" onclick="toggleModal('edit-modal', false)">
        <div id="edit-modal-content" onclick="event.stopPropagation()">
            <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
            <div class="edit-group"><label class="edit-label">–Ü–º'—è</label><input id="edit-name" class="edit-input"></div>
            <div class="edit-group"><label class="edit-label">–°—Ç–∞—Ç—É—Å</label><input id="edit-bio" class="edit-input"></div>
            <div class="edit-group"><label class="edit-label">–ú—ñ—Å—Ç–æ</label><input id="edit-location" class="edit-input"></div>
            <div class="edit-group"><label class="edit-label">–°—Ç–∏–ª—å</label><input id="edit-style" class="edit-input"></div>
            <div class="edit-group"><label class="edit-label">–°–Ω–∞—Å—Ç—ñ</label><input id="edit-gear" class="edit-input"></div>
            <div class="edit-group"><label class="edit-label">–ú—ñ—Å—Ü—è</label><input id="edit-spots" class="edit-input"></div>
            <div class="edit-group"><label class="edit-label">–§–æ—Ç–æ URL</label><input id="edit-photo" class="edit-input"></div>
            <button onclick="saveProfile()" class="btn-primary" style="width:100%">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCN7xN8AZXXCxwf9GmuILYi5AcKAUYJVB4",
            authDomain: "fishnet-cb1ad.firebaseapp.com",
            projectId: "fishnet-cb1ad",
            messagingSenderId: "672721719482",
            appId: "1:672721719482:web:9b0ce0e3e41893fcccb283"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let myFollowing = [];
        let allPosts = [];
        let viewingUid = null;
        
        // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –ö–∞—Ä—Ç–∏
        let map = null;
        let currentPostLocation = null; // –¢–∏–º—á–∞—Å–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞

        // --- NAVIGATION ---
        window.goHome = () => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-home').classList.add('active');
            renderFeed(allPosts);
        };

        window.goToMap = () => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-map').classList.add('active');
            initMap(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–∞—Ä—Ç—É
        };

        window.goToProfile = async (uid) => {
            viewingUid = uid;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-profile').classList.add('active');
            loadProfileData(uid);
        };

        window.goToMyProfile = () => currentUser ? window.goToProfile(currentUser.uid) : signInWithPopup(auth, new GoogleAuthProvider());

        // --- MAP LOGIC (LEAFLET) ---
        function initMap() {
            if (!map) {
                // –¶–µ–Ω—Ç—Ä—É—î–º–æ –Ω–∞ –£–∫—Ä–∞—ó–Ω—ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                map = L.map('map').setView([49.0, 31.0], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
            }
            // –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –≥–ª—é–∫ –∑ —Ä–æ–∑–º—ñ—Ä–æ–º –∫–∞—Ä—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—ñ –≤–∫–ª–∞–¥–æ–∫
            setTimeout(() => { map.invalidateSize(); renderMapMarkers(); }, 100);
        }

        function renderMapMarkers() {
            // –ß–∏—Å—Ç–∏–º–æ —Å—Ç–∞—Ä—ñ –º–∞—Ä–∫–µ—Ä–∏ (–ø—Ä–æ—Å—Ç–∏–π —Å–ø–æ—Å—ñ–± - –ø–µ—Ä–µ–º–∞–ª—é–≤–∞—Ç–∏ –≤—Å–µ, –∞–ª–µ –¥–ª—è MVP –æ–∫)
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) { map.removeLayer(layer); }
            });

            allPosts.forEach(post => {
                if (post.location) {
                    const marker = L.marker([post.location.lat, post.location.lng]).addTo(map);
                    
                    const popupContent = `
                        <div style="width:160px;">
                            ${post.imageUrl ? `<img src="${post.imageUrl}" class="map-popup-img" style="width:100%;height:100px;object-fit:cover;border-radius:8px;">` : ''}
                            <div class="map-popup-text">
                                <div class="map-popup-author">${post.author}</div>
                                ${post.text.substring(0, 50)}...
                            </div>
                            <button onclick="goToProfile('${post.uid}')" style="width:100%;background:#0072ff;color:white;border:none;padding:5px;border-radius:5px;cursor:pointer;">–ü—Ä–æ—Ñ—ñ–ª—å</button>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                }
            });
        }

        // --- GPS LOGIC ---
        window.getLocation = () => {
            const btn = document.getElementById('location-btn');
            btn.innerText = "‚è≥ –®—É–∫–∞—î–º–æ —Å—É–ø—É—Ç–Ω–∏–∫–∏...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPostLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        btn.innerHTML = "‚úÖ –ú—ñ—Å—Ü–µ –¥–æ–¥–∞–Ω–æ!";
                        btn.classList.add('active');
                    },
                    (error) => {
                        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏ GPS.");
                        btn.innerText = "üìç –î–æ–¥–∞—Ç–∏ –º—ñ—Å—Ü–µ (GPS)";
                    }
                );
            } else { 
                alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î GPS");
            }
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('fab').classList.remove('hidden');
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    await setDoc(userRef, { name: user.displayName, photo: user.photoURL, following: [], bio: "–†–∏–±–∞–ª–∫–∞" });
                }
                myFollowing = snap.exists() ? (snap.data().following || []) : [];
            } else {
                document.getElementById('fab').classList.add('hidden');
                goHome();
            }
            renderFeed(allPosts);
        });

        // --- PROFILE LOGIC ---
        async function loadProfileData(uid) {
            const userSnap = await getDoc(doc(db, "users", uid));
            const data = userSnap.exists() ? userSnap.data() : {};
            document.getElementById('p-name').textContent = data.name || "–ê–Ω–æ–Ω—ñ–º";
            document.getElementById('p-bio').textContent = data.bio || "";
            document.getElementById('p-avatar').src = data.photo || "https://ui-avatars.com/api/?name=" + (data.name || "A");
            document.getElementById('p-following').textContent = (data.following || []).length;
            
            ['location', 'style', 'gear', 'spots'].forEach(field => {
                document.getElementById('p-'+field).textContent = data[field] || "-";
            });

            const btn = document.getElementById('p-action-btn');
            if (currentUser && currentUser.uid === uid) {
                btn.textContent = "‚öôÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏"; btn.className = "btn-secondary"; btn.onclick = () => openEditModal(data);
            } else if (currentUser) {
                const isFollowing = myFollowing.includes(uid);
                btn.textContent = isFollowing ? "–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è" : "–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è";
                btn.className = isFollowing ? "btn-secondary" : "btn-primary";
                btn.onclick = () => toggleFollow(uid);
            } else { btn.style.display = 'none'; }

            const wallContainer = document.getElementById('profile-feed');
            wallContainer.innerHTML = '';
            allPosts.filter(p => p.uid === uid).forEach(post => wallContainer.appendChild(createPostElement(post)));
        }

        // --- PUBLISH POST ---
        window.publishPost = async () => {
            const text = document.getElementById('message').value;
            const file = document.getElementById('imageInput').files[0];
            if(!text && !file) return;
            
            let imageUrl = null;
            if(file) {
                 const reader = new FileReader();
                 reader.readAsDataURL(file);
                 await new Promise(r => reader.onload = r);
                 imageUrl = reader.result; 
            }

            await addDoc(collection(db, "posts"), {
                text: text, imageUrl: imageUrl, timestamp: serverTimestamp(),
                uid: currentUser.uid, author: currentUser.displayName, photo: currentUser.photoURL, 
                likes: [], location: currentPostLocation // –î–æ–¥–∞—î–º–æ –ª–æ–∫–∞—Ü—ñ—é –≤ –±–∞–∑—É
            });
            
            // –°–∫–∏–¥–∞–Ω–Ω—è
            window.toggleModal('post-modal', false);
            document.getElementById('message').value = '';
            document.getElementById('location-btn').innerText = "üìç –î–æ–¥–∞—Ç–∏ –º—ñ—Å—Ü–µ (GPS)";
            document.getElementById('location-btn').classList.remove('active');
            currentPostLocation = null;
        };

        // --- HELPERS (Same as before) ---
        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snapshot) => {
            allPosts = [];
            snapshot.forEach(doc => allPosts.push({ id: doc.id, ...doc.data() }));
            if(document.getElementById('view-home').classList.contains('active')) renderFeed(allPosts);
            else if(document.getElementById('view-map').classList.contains('active')) renderMapMarkers(); // –û–Ω–æ–≤–∏—Ç–∏ –∫–∞—Ä—Ç—É —è–∫—â–æ –≤–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞
            else if (viewingUid) loadProfileData(viewingUid);
        });

        function createPostElement(post) {
            const isLiked = currentUser && (post.likes || []).includes(currentUser.uid);
            const div = document.createElement('div');
            div.className = 'post';
            div.innerHTML = `
                <div class="post-header">
                    <img src="${post.photo || 'https://ui-avatars.com/api/?name='+post.author}" class="avatar" onclick="goToProfile('${post.uid}')">
                    <div style="flex:1;">
                        <div class="author-name" onclick="goToProfile('${post.uid}')">${post.author}</div>
                        <div style="font-size:12px; color:#aaa;">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleDateString() : '...'} ${post.location ? 'üìç' : ''}</div>
                    </div>
                </div>
                ${post.text ? `<div class="post-text">${post.text}</div>` : ''}
                ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image">` : ''}
                <div class="actions">
                    <button class="action-btn ${isLiked ? 'like-active' : ''}" onclick="toggleLike('${post.id}', ${isLiked})">
                        ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likes ? post.likes.length : 0}
                    </button>
                    ${post.location ? `<button class="action-btn" onclick="goToMap()">üó∫Ô∏è –ù–∞ –∫–∞—Ä—Ç—ñ</button>` : ''}
                </div>
            `;
            return div;
        }
        
        // ... (–Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó: editModal, saveProfile, toggleFollow, toggleLike, filterFeed, deletePost - —Ç–∞–∫—ñ —Å–∞–º—ñ —è–∫ –≤ –º–∏–Ω—É–ª–æ–º—É –∫–æ–¥—ñ) ...
        // –Ø —Å–∫–æ—Ä–æ—Ç–∏–≤ —ó—Ö —Ç—É—Ç –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º—ñ—Å—Ü—è, –∞–ª–µ –≤–æ–Ω–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω—ñ, —è–∫ —É –≤–µ—Ä—Å—ñ—ó 5.0
        
        function openEditModal(data) {
            ['name','bio','location','style','gear','spots','photo'].forEach(f => document.getElementById('edit-'+f).value = data[f] || "");
            window.toggleModal('edit-modal', true);
        }
        window.saveProfile = async () => {
            const updates = {};
            ['name','bio','location','style','gear','spots','photo'].forEach(f => updates[f] = document.getElementById('edit-'+f).value);
            await updateDoc(doc(db, "users", currentUser.uid), updates);
            window.toggleModal('edit-modal', false);
            loadProfileData(currentUser.uid);
        };
        window.toggleModal = (id, show) => { document.getElementById(id).classList.toggle('open', show); };
        if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
        document.getElementById('themeBtn').onclick = () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); };
        window.toggleFollow = async (uid) => { const ref = doc(db, "users", currentUser.uid); if(myFollowing.includes(uid)) { await updateDoc(ref, { following: arrayRemove(uid) }); myFollowing = myFollowing.filter(id => id !== uid); } else { await updateDoc(ref, { following: arrayUnion(uid) }); myFollowing.push(uid); } loadProfileData(uid); };
        window.toggleLike = (id, isLiked) => { if (!currentUser) return; const ref = doc(db, "posts", id); updateDoc(ref, { likes: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) }); };
        document.getElementById('searchInput').oninput = (e) => { const term = e.target.value.toLowerCase(); renderFeed(allPosts.filter(p => p.text?.toLowerCase().includes(term) || p.author.toLowerCase().includes(term))); };
        window.filterFeed = (type) => { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); if(type === 'all') renderFeed(allPosts); if(type === 'friends') renderFeed(allPosts.filter(p => myFollowing.includes(p.uid) || p.uid === currentUser.uid)); };
        window.deletePost = (id) => confirm("–í–∏–¥–∞–ª–∏—Ç–∏?") && deleteDoc(doc(db, "posts", id));

    </script>
</body>
</html>
